<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Django and Wagtail Migrations - consumerfinance.gov</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/overrides.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Django and Wagtail Migrations";
        var mkdocs_page_input_path = "migrations.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> consumerfinance.gov
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation/">Setup</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Running this Project</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../running-virtualenv/">Running in a Virtual Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../running-docker/">Running in Docker</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../running-k8s/">Running in Kubernetes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../running-docs/">Running documentation site locally</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../debugging-monitoring/">Debugging and Monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../deployment/">Artifacts and Deployment</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Pages and Components</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../atomic-structure/">Atomic Structure and Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../editing-components/">Creating and Editing Components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../debugging-templates/">Debugging Templates</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Django and Wagtail Migrations</a>
    <ul class="current">
    
        <ul>
        
            <li><a class="toctree-l4" href="#table-of-contents">Table of contents</a></li>
        
            <li><a class="toctree-l4" href="#reference-material">Reference material</a></li>
        
            <li><a class="toctree-l4" href="#do-i-need-to-create-a-migration">Do I need to create a migration?</a></li>
        
            <li><a class="toctree-l4" href="#schema-migrations">Schema migrations</a></li>
        
            <li><a class="toctree-l4" href="#data-migrations">Data migrations</a></li>
        
            <li><a class="toctree-l4" href="#squashing-migrations">Squashing migrations</a></li>
        
        </ul>
    

    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wagtail-pages/">Wagtail Pages</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Supporting Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../browser-support/">Browser Support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../caching/">Caching</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../feature-flags/">Feature Flags</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../filterable-lists/">Filterable Lists</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../page-search/">Page Search</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../site-search/">Site Search</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../sso/">Single Sign-On</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../translation/">Translation</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Testing</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../javascript-unit-tests/">JavaScript Unit Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../python-unit-tests/">Python Unit Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../functional-testing/">Functional Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../profiling-django/">Profiling Django</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../other-front-end-testing/">Other Front-end Testing</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Contributing</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../branching-merging/">Branching and Merging</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../contributing-docs/">Contributing to the Docs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../related-projects/">Related Projects</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development-tips/">Development Tips</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../github-actions/">How We Use GitHub Actions</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">APIs and Data</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../ask-cfpb/">Ask CFPB</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../consumer-complaint-database/">Consumer Complaints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../housing-counselor-tool/">Find a Housing Counselor Tool</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">consumerfinance.gov</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Pages and Components</li>
      <li class="breadcrumb-item active">Django and Wagtail Migrations</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/cfpb/consumerfinance.gov/edit/master/docs/migrations.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="django-and-wagtail-migrations">Django and Wagtail Migrations<a class="headerlink" href="#django-and-wagtail-migrations" title="Permanent link">¶</a></h1>
<p>Adding or changing fields on Django models, Wagtail page models
(which are a particular kind of Django model), or StreamField block classes
will always require a new <a href="#schema-migrations">Django schema migration</a>;
additionally, changing field names or types on an existing block will require a
<a href="#data-migrations">Django data migration</a>.</p>
<h2 id="table-of-contents">Table of contents<a class="headerlink" href="#table-of-contents" title="Permanent link">¶</a></h2>
<ol>
<li><a href="#reference-material">Reference material</a></li>
<li><a href="#do-i-need-to-create-a-migration">Do I need to create a migration?</a></li>
<li><a href="#schema-migrations">Schema migrations</a></li>
<li><a href="#data-migrations">Data migrations</a></li>
<li><a href="#wagtail-specific-considerations">Wagtail-specific consideration</a></li>
<li><a href="#squashing-migrations">Squashing migrations</a></li>
</ol>
<h2 id="reference-material">Reference material<a class="headerlink" href="#reference-material" title="Permanent link">¶</a></h2>
<p>The following links may be useful for setting context or diving deeper
into the concepts presented throughout this page:</p>
<ul>
<li><a href="https://docs.djangoproject.com/en/stable/topics/migrations/">Django migrations documentation</a></li>
<li><a href="https://docs.djangoproject.com/en/stable/topics/migrations/#data-migrations">Django data migrations documentation</a></li>
<li><a href="https://docs.wagtail.io/en/stable/topics/streamfield.html#migrations">Wagtail Streamfield migrations documentation</a></li>
</ul>
<h2 id="do-i-need-to-create-a-migration">Do I need to create a migration?<a class="headerlink" href="#do-i-need-to-create-a-migration" title="Permanent link">¶</a></h2>
<p>A new Django migration is required for most, but not all, changes that you
make to the definitions of Django model classes. Even experienced Django
developers may find it unintuitive to determine which changes will require
a migration.</p>
<p>Example model changes that require a migration:</p>
<ul>
<li>Adding, removing, or renaming a model field</li>
<li>Changing a model field definition in a way that impacts the database schema
  (for example, changing the size of a <code>CharField</code>)</li>
<li>Changing a model field definition in a way that does not impact the database schema
  (for example, changing the field's <code>help_text</code>)</li>
</ul>
<p>Example model changes that do not require a migration:</p>
<ul>
<li>Adding, removing, renaming, or modifying a model class method</li>
<li>Modifying a model class <a href="https://docs.djangoproject.com/en/stable/topics/db/managers/">manager</a></li>
</ul>
<p>The best way to tell if your changes require a migration is to ask Django to
determine that for you. Django's
<a href="https://docs.djangoproject.com/en/stable/ref/django-admin/#django-admin-makemigrations">makemigrations</a>
management command can be used for this purpose:</p>
<pre class="highlight"><code class="language-bash">./cfgov/manage.py makemigrations --dry-run</code></pre>
<p>If you haven't made any changes to your local source code that would necessitate the
creation of a new migration, this command will print <code>No changes detected</code>.</p>
<p>Otherwise, if you have made changes that require a migration, Django will print
information about the migration that would need to be created:</p>
<pre class="highlight"><code class="language-bash">Migrations for 'v1':
  cfgov/v1/migrations/0154_auto_20190412_1008.py
    - Alter field alt on cfgovimage</code></pre>
<p>Running with the <code>--dry-run</code> flag won't actually create any migration files on disk.
See below for more information on how to do this, including how to give your
migrations a more descriptive name.</p>
<h2 id="schema-migrations">Schema migrations<a class="headerlink" href="#schema-migrations" title="Permanent link">¶</a></h2>
<p>Any time you add or change a field on a Django model, Wagtail page model
(which are a particular kind of Django model), or StreamField block class, a
<a href="https://docs.djangoproject.com/en/stable/topics/migrations">Django schema migration</a>
will be required. This includes changes as small as modifying the <code>help_text</code> string.</p>
<p>To automatically generate a schema migration,
run the following, editing it to give your migration a name
that briefly describes the change(s) you're making:</p>
<pre class="highlight"><code class="language-bash">./cfgov/manage.py makemigrations -n &lt;description_of_changes&gt;</code></pre>
<p>For examples of good migration names, look through some of
<a href="https://github.com/cfpb/consumerfinance.gov/tree/main/cfgov/v1/migrations">our existing migration files</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some changes will generate multiple migration files.
If you change a block that is used in pages defined in different sub-apps,
you will see a migration file for each of those sub-apps.</p>
</div>
<h3 id="migration-numbering-and-conflicts">Migration numbering and conflicts<a class="headerlink" href="#migration-numbering-and-conflicts" title="Permanent link">¶</a></h3>
<p>When a migration file is generated, it will automatically be given
a unique four-digit number at the beginning of its filename.
These numbers are assigned in sequence, and they end up being
a regular source of conflicts between pull requests
that are in flight at the same time.
If a PR with a migration gets merged between the time you create your migration
and the time that your PR is ready for merging,
you will have to update your branch as normal to be current with main
and then re-create your migration.
Also note that our
<a href="../github-actions/">back-end tests that run in GitHub Actions</a>
will fail if a required schema migration is missing or if
migrations are in conflict with one another.</p>
<h2 id="data-migrations">Data migrations<a class="headerlink" href="#data-migrations" title="Permanent link">¶</a></h2>
<p><a href="https://docs.djangoproject.com/en/stable/topics/migrations/#data-migrations">Data migrations</a>
are required any time you:</p>
<ul>
<li>rename an existing field</li>
<li>change the type of an existing field</li>
<li>delete an existing field</li>
<li>rename a block within a StreamField</li>
<li>delete a block</li>
</ul>
<p>if you do not want to lose any data already stored in that field or block.</p>
<p>In other words, if an existing field or block is changing,
any data stored in that field or block has to be migrated to a different place,
unless you're OK with jettisoning it.</p>
<p>There is no automatic generation mechanism like there is for schema migrations.
You must write the script by hand that automates the transfer of data
from old fields to new fields.</p>
<p>To generate an empty migration file for your data migration, run:</p>
<pre class="highlight"><code class="language-bash">./cfgov/manage.py makemigrations --empty yourappname</code></pre>
<p>You can also copy the code below to get started with
<code>forward()</code> and <code>backward()</code> functions to migrate your model's data:</p>
<pre class="highlight"><code class="language-python">from django.db import migrations


def forwards(apps, schema_editor):
    MyModel = apps.get_model('yourappname', 'MyModel')
    for obj in MyModel.objects.all():
        # Make forward changes to the object
        pass


def backwards(apps, schema_editor):
    MyModel = apps.get_model('yourappname', 'MyModel')
    for obj in MyModel.objects.all():
        # Make backward changes to the object
        pass


class Migration(migrations.Migration):
    dependencies = []
    operations = [
        migrations.RunPython(forwards, backwards),
    ]</code></pre>
<p>The <code>forwards()</code> and <code>backwards()</code> functions are where any changes
that need to happen to a model's data are made.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While backwards migrations are necessary in external libraries that we create,
we do not require them in consumerfinance.gov
because we prefer not to rollback migrations that have already been applied.</p>
</div>
<h3 id="wagtail-specific-considerations">Wagtail-specific considerations<a class="headerlink" href="#wagtail-specific-considerations" title="Permanent link">¶</a></h3>
<p>Django data migrations with Wagtail can be challenging because
<a href="https://github.com/wagtail/wagtail/issues/1101">programmatic editing of Wagtail pages is difficult</a>,
and pages have both revisions and StreamFields.</p>
<p>Helpfully, Wagtail includes some utility functions that make it easier to
write StreamField data migrations. These are described in detail
<a href="https://docs.wagtail.org/en/stable/advanced_topics/streamfield_migrations.html#streamfield-data-migrations">in the Wagtail documentation</a>.</p>
<h2 id="squashing-migrations">Squashing migrations<a class="headerlink" href="#squashing-migrations" title="Permanent link">¶</a></h2>
<p><a href="#schema-migrations">As described above</a>,
each time a Django model's definition changes it requires the generation of a new Django migration.
Over time, the number of migrations in our apps can grow very large,
slowing down testing and the <code>migrate</code> command.</p>
<p>For this reason it may be desirable to periodically delete and recreate the migration files,
so that instead of a series of files detailing every change over time
we have a smaller set that just describes the current state of models in the code.</p>
<p>Django provides an automated
<a href="https://docs.djangoproject.com/en/stable/topics/migrations/#squashing-migrations">squashing</a>
process for migrations, but this is often not optimal when migrations contain manual <code>RunPython</code> blocks are present.
Before running <code>squashmigrations</code>, search existing migrations for <code>RunPython</code> blocks without <code>elidable=True</code>, and
correct them to have <code>elidable=True</code>. This will tell <code>squashmigrations</code> to drop that <code>RunPython</code> block.
In almost <em>all</em> cases, we do not want to keep any <code>RunPython</code> blocks.
It is highly recommended to get a postgres database setup with the current migrations before
attempting to squash.</p>
<ol>
<li>Set all <code>RunPython</code> blocks to have the argument <code>elidable=True</code>.</li>
<li>Squash migrations for each app that has 3 or more non-squashed migrations</li>
</ol>
<pre class="highlight"><code class="language-sh"># start migration number is optional for apps that have never been squashed
cfgov/manage.py squashmigrations --squashed-name &lt;year&gt;_squash &lt;app_name&gt; &lt;starting_migration_number&gt; &lt;ending_migration_number&gt;

# 2022 ask_cfp squash 0039 -&gt; 0045
cfgov/manage.py squashmigrations --squashed-name 2022_squash ask_cfpb 0039 0045

# 2022 form_explainer squash 0001 -&gt; 0007
cfgov/manage.py squashmigrations --squashed-name 2022_squash form_explainer 0007</code></pre>
<ol>
<li>Once all apps are squashed, attempt to apply migrations to check for errors</li>
</ol>
<pre class="highlight"><code class="language-sh">cfgov/manage.py migrate</code></pre>
<ol>
<li>
<p>Correct errors, if any, until there are no migrations to apply or create.
   Repeat steps 3 and 4 until no errors.
   It may be possible that an additional migration will be generated
   if there was an error that needed to be corrected.</p>
</li>
<li>
<p>Unittest with squashed migrations in place</p>
</li>
<li>Recreate fresh database, and load <code>test.sql.gz</code>, and apply the migrations.</li>
</ol>
<pre class="highlight"><code class="language-sh">./refresh-data.sh test.sql.gz</code></pre>
<ol>
<li>Dump test database back to <code>test.sql.gz</code></li>
</ol>
<pre class="highlight"><code class="language-sh">./dump-data.sh test.sql.gz</code></pre>
<ol>
<li>Delete non-squashed migration files that were squashed.</li>
</ol>
<h3 id="squash-notes">Squash Notes<a class="headerlink" href="#squash-notes" title="Permanent link">¶</a></h3>
<h4 id="2022">2022<a class="headerlink" href="#2022" title="Permanent link">¶</a></h4>
<p><code>teachers_digital_platform</code> had an over-optimization or circular dependency
issue, resulting in the following error.</p>
<pre class="highlight"><code>ValueError: The field teachers_digital_platform.ActivityPage.student_characteristics was declared with a lazy reference to 'teachers_digital_platform.activityspecialpopulation', but app 'teachers_digital_platform' doesn't provide model 'activityspecialpopulation'.
The field teachers_digital_platform.ActivityPage_student_characteristics.activityspecialpopulation was declared with a lazy reference to 'teachers_digital_platform.activityspecialpopulation', but app 'teachers_digital_platform' doesn't provide model 'activityspecialpopulation'.</code></pre>
<p>Corrected the error by changing the reference to the correct field for student char.
An additional migration was generated for <code>teachers_digital_platform</code> once this error was corrected.
<code>ActivitySpecialPopulation</code> -&gt; <code>ActivityStudentCharacteristics</code>.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../debugging-templates/" class="btn btn-neutral float-left" title="Debugging Templates"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../wagtail-pages/" class="btn btn-neutral float-right" title="Wagtail Pages">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/cfpb/consumerfinance.gov" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../debugging-templates/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../wagtail-pages/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
