<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Artifacts and Deployment - consumerfinance.gov</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  <link href="../css/overrides.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Artifacts and Deployment";
    var mkdocs_page_input_path = "deployment.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> consumerfinance.gov</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../installation/">Setup</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Running this Project</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../running-virtualenv/">Running in a Virtual Environment</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../running-docker/">Running in Docker</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../debugging-monitoring/">Debugging and Monitoring</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Artifacts and Deployment</a>
    <ul class="current">
    

    

    

    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Pages and Components</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../atomic-structure/">Atomic Structure and Design</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../editing-components/">Creating and Editing Components</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../debugging-templates/">Debugging Templates</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../migrations/">Django and Wagtail Migrations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../forms-in-wagtail/">Forms in Wagtail Page Context</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../wagtail-pages/">Wagtail Pages</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Supporting Features</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../caching/">Caching</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../feature-flags/">Feature Flags</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../filterable-lists/">Filterable Lists</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../page-search/">Page Search</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../site-search/">Site Search</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../translation/">Translation</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Testing</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../javascript-unit-tests/">JavaScript Unit Testing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../python-unit-tests/">Python Unit Testing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../functional-testing/">Functional Testing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../profiling-django/">Profiling Django</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../other-front-end-testing/">Other Front-end Testing</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Contributing</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../branching-merging/">Branching and Merging</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../contributing-docs/">Contributing to the Docs</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../related-projects/">Related Projects</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../development-tips/">Development Tips</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../github-actions/">How We Use GitHub Actions</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">APIs and Data</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../ask-cfpb/">Ask CFPB</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../consumer-complaint-database/">Consumer Complaints</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../housing-counselor-tool/">Find a Housing Counselor Tool</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../website-feedback/">Website Feedback</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">consumerfinance.gov</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Running this Project &raquo;</li>
        
      
    
    <li>Artifacts and Deployment</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/cfpb/consumerfinance.gov/edit/master/docs/deployment.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <p>This repository includes code for generating a self-extracting zip archive
of the code and all of its Python dependencies. We use these
archives to deploy the site to a Linux server.</p>
<h1 id="generating-a-deployment-artifact">Generating a deployment artifact<a class="headerlink" href="#generating-a-deployment-artifact" title="Permanent link">¶</a></h1>
<p>Running the script at <code>./docker/deployable-zipfile/build.sh</code> will start a CentOS 6
container, generate the artifact (via
<a href="https://github.com/cfpb/consumerfinance.gov/blob/main/docker/deployable-zipfile/_build.sh">this script</a>),
and save it to <code>./cfgov_current_build.zip</code>.</p>
<p>We use CentOS 6 here, so that the Python modules that include compiled code, will
be compiled for the same environment they will be run in.</p>
<h1 id="whats-in-an-artifact">What's in an artifact?<a class="headerlink" href="#whats-in-an-artifact" title="Permanent link">¶</a></h1>
<p>Here's a (very abbreviated) peek into what's <em>in</em> the zip file:</p>
<pre class="highlight"><code>__main__.py
cfgov.pth
install_wheels.py
loadenv.py
loadenv-init.pth
wheels/botocore-1.10.84-py2.py3-none-any.whl
wheels/tqdm-4.15.0-py2.py3-none-any.whl
...
static.in/0/
static.in/0/fonts/
static.in/0/fonts/8344e877-560d-44d4-82eb-9822766676f9.woff
...
bootstrap_wheels/setuptools-41.2.0-py2.py3-none-any.whl
bootstrap_wheels/pip-19.2.3-py2.py3-none-any.whl
cfgov/...</code></pre>

<p>The <code>__main__.py</code> file contains <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/deployable_zipfile/extract.py">the code that runs when the zip file is invoked
as a Python module</a>.</p>
<p>The <code>wheels/</code> directory contains all of our python dependencies, while
<code>bootstrap_wheels/</code> contains modules needed at deployment time, to install
everything.</p>
<p><code>loadenv.py</code> and <code>loadenv-init.pth</code> are used to load environment variables from
a <code>environment.json</code> file, deployed seperately.</p>
<p>Before the final version of the zip file is saved, we prepend a python "shebang" line,
<code>#!/usr/bin/env python</code>. This, combined with <code>__main__.py</code> described above, is what makes
the file executable and self-extracting.</p>
<h1 id="deploying-an-artifact">Deploying an artifact<a class="headerlink" href="#deploying-an-artifact" title="Permanent link">¶</a></h1>
<p>We currently use Ansible to prepare servers to run an artifact, and to do the actual deployment.
If we ignore some specifics and quirks of our environment, the basic steps look something like this:</p>
<ol>
<li>copy the artifact to the system</li>
<li>execute the artifact, with the -d (destination) argument, <code>./artifact.zip -d destination-dir</code>. This
   will unpack the files, create a new virtualenv, and install all of the wheels in <code>wheels/</code> into that
   virtualenv. <strong>Important Note:</strong> This should be done with the same Python interpreter that will run the
   application. For example, on our servers this means using <a href="https://linux.die.net/man/1/scl"><code>scl enable</code></a>
   to specify a particular Python version from 
   <a href="https://www.softwarecollections.org/en/scls/?search=python">Software Collections</a>.</li>
<li>put an <code>environment.json</code> file in place, in your <code>destination-dir</code></li>
<li>run Django utilities like 'collectstatic' and 'migrate'</li>
<li>update a symlink to point to the latest release</li>
<li>restart your WSGI server.</li>
</ol>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../atomic-structure/" class="btn btn-neutral float-right" title="Atomic Structure and Design">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../debugging-monitoring/" class="btn btn-neutral" title="Debugging and Monitoring"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/cfpb/consumerfinance.gov/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../debugging-monitoring/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../atomic-structure/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
