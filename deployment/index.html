<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Artifacts and Deployment - consumerfinance.gov</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/overrides.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Artifacts and Deployment";
        var mkdocs_page_input_path = "deployment.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> consumerfinance.gov
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation/">Setup</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Running this Project</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../running-virtualenv/">Running in a Virtual Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../running-docker/">Running in Docker</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../running-k8s/">Running in Kubernetes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../running-docs/">Running documentation site locally</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../debugging-monitoring/">Debugging and Monitoring</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Artifacts and Deployment</a>
    <ul class="current">
    
        <ul>
        
            <li><a class="toctree-l4" href="#generating-an-artifact">Generating an artifact</a></li>
        
            <li><a class="toctree-l4" href="#whats-in-an-artifact">What's in an artifact?</a></li>
        
            <li><a class="toctree-l4" href="#deploying-an-artifact">Deploying an artifact</a></li>
        
            <li><a class="toctree-l4" href="#testing-an-artifact">Testing an artifact</a></li>
        
        </ul>
    

    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Pages and Components</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../atomic-structure/">Atomic Structure and Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../editing-components/">Creating and Editing Components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../debugging-templates/">Debugging Templates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../migrations/">Django and Wagtail Migrations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wagtail-pages/">Wagtail Pages</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Supporting Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../browser-support/">Browser Support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../caching/">Caching</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../feature-flags/">Feature Flags</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../filterable-lists/">Filterable Lists</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../page-search/">Page Search</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../site-search/">Site Search</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../sso/">Single Sign-On</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../translation/">Translation</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Testing</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../javascript-unit-tests/">JavaScript Unit Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../python-unit-tests/">Python Unit Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../functional-testing/">Functional Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../profiling-django/">Profiling Django</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../other-front-end-testing/">Other Front-end Testing</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Contributing</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../branching-merging/">Branching and Merging</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../contributing-docs/">Contributing to the Docs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../related-projects/">Related Projects</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development-tips/">Development Tips</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../github-actions/">How We Use GitHub Actions</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">APIs and Data</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../ask-cfpb/">Ask CFPB</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../consumer-complaint-database/">Consumer Complaints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../housing-counselor-tool/">Find a Housing Counselor Tool</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">consumerfinance.gov</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Running this Project</li>
      <li class="breadcrumb-item active">Artifacts and Deployment</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/cfpb/consumerfinance.gov/edit/master/docs/deployment.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="deploying-to-rhelcentos-servers">Deploying to RHEL/CentOS servers<a class="headerlink" href="#deploying-to-rhelcentos-servers" title="Permanent link">¶</a></h1>
<p>This repository includes code for generating a self-extracting zip archive
of the code and all of its Python dependencies. We use these
archives to deploy the site to a Linux server.</p>
<h2 id="generating-an-artifact">Generating an artifact<a class="headerlink" href="#generating-an-artifact" title="Permanent link">¶</a></h2>
<p>We use a custom CentOS 7-based Docker image (<code>cfgov-artifact-builder</code>) to build
deployment artifacts.
CentOS is used so that the Python modules that include compiled code will
be compiled for the same environment in which they will be run.</p>
<p>This image is updated automatically via GitHub Actions and stored in the
GitHub Container registry.</p>
<p>To download the image from GitHub (after first
<a href="https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry#authenticating-to-the-container-registry">authenticating</a>):</p>
<pre class="highlight"><code class="language-sh">docker pull ghcr.io/cfpb/cfgov-artifact-builder:latest</code></pre>
<p>Alternatively, to build the image locally:</p>
<pre class="highlight"><code class="language-sh">docker build docker/centos7 --target=cfgov-artifact-builder -t ghcr.io/cfpb/cfgov-artifact-builder:latest</code></pre>
<p>To use the image to build a deployable artifact from your local source code:</p>
<pre class="highlight"><code class="language-sh">docker run -v `pwd`:/cfgov ghcr.io/cfpb/cfgov-artifact-builder:latest</code></pre>
<p>The generated artifact will be created in the current directory as
<code>cfgov_current_build.zip</code>.</p>
<p>Note that artifacts generated locally may include extra files from local development
directories that are not intended to be deployed to production.
Only artifacts generated in a clean environment (e.g. on GitHub Actions)
should be used in real deployments.</p>
<h2 id="whats-in-an-artifact">What's in an artifact?<a class="headerlink" href="#whats-in-an-artifact" title="Permanent link">¶</a></h2>
<p>A deployable artifact is a zipfile that can be executed by Python.
It contains the full project source code and static assets
along with various additional files.</p>
<p>A <code>__main__.py</code> file contains <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/deployable_zipfile/extract.py">the code that runs when the zip file is invoked
as a Python module</a>.</p>
<p>A <code>wheels/</code> directory contains all of our python dependencies, while
<code>bootstrap_wheels/</code> contains modules needed at deployment time, to install
everything.</p>
<p><code>loadenv.py</code> and <code>loadenv-init.pth</code> are used to load environment variables from
a <code>environment.json</code> file, deployed seperately.</p>
<p>Before the final version of the zip file is saved, we prepend a python "shebang"
line, <code>#!/usr/bin/env python</code>.
This, combined with <code>__main__.py</code> described above, is what makes the file
executable and self-extracting.</p>
<h2 id="deploying-an-artifact">Deploying an artifact<a class="headerlink" href="#deploying-an-artifact" title="Permanent link">¶</a></h2>
<p>We currently use Ansible to prepare servers to run an artifact, and to do the actual deployment.
If we ignore some specifics and quirks of our environment, the basic steps look something like this:</p>
<ol>
<li>copy the artifact to the system</li>
<li>execute the artifact, with the -d (destination) argument, <code>./artifact.zip -d destination-dir</code>. This
   will unpack the files, create a new virtualenv, and install all of the wheels in <code>wheels/</code> into that
   virtualenv. <strong>Important Note:</strong> This should be done with the same Python interpreter that will run the
   application. For example, on our servers this means using <a href="https://linux.die.net/man/1/scl"><code>scl enable</code></a>
   to specify a particular Python version from
   <a href="https://www.softwarecollections.org/en/scls/?search=python">Software Collections</a>.</li>
<li>put an <code>environment.json</code> file in place, in your <code>destination-dir</code></li>
<li>run Django utilities like 'collectstatic' and 'migrate'</li>
<li>update a symlink to point to the latest release</li>
<li>restart your WSGI server.</li>
</ol>
<h2 id="testing-an-artifact">Testing an artifact<a class="headerlink" href="#testing-an-artifact" title="Permanent link">¶</a></h2>
<p>A CentOS-based Docker image (<code>cfgov-artifact-tester</code>) can be used to test deployable artifacts locally without requiring access to a Linux server.
This image unpacks a deployable artifact and runs it in a Docker container in the
same way it runs on RHEL/CentOS servers.</p>
<p>This image is updated automatically via GitHub Actions and stored in the
GitHub Container registry.</p>
<p>To download the image from GitHub (after first
<a href="https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry#authenticating-to-the-container-registry">authenticating</a>):</p>
<pre class="highlight"><code class="language-sh">docker pull ghcr.io/cfpb/cfgov-artifact-tester:latest</code></pre>
<p>Alternatively, to build the image locally:</p>
<pre class="highlight"><code class="language-sh">docker build docker/centos7 --target=cfgov-artifact-tester -t ghcr.io/cfpb/cfgov-artifact-tester:latest</code></pre>
<p>To use the image to test a local deployable artifact named <code>cfgov_current_build.zip</code>:</p>
<pre class="highlight"><code class="language-sh">docker run -it -v `pwd`:/cfgov:ro -p 8000:80 --env-file docker/centos7/test.env cfgov-artifact-tester:latest</code></pre>
<p>Running this container extracts the local artifact and serves it using an Apache
webserver accessible locally at <a href="http://localhost:8000">http://localhost:8000</a>.</p>
<p>The <code>docker/centos7/test.env</code> file includes various environment variables that can
be modified to alter the application's behavior.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../debugging-monitoring/" class="btn btn-neutral float-left" title="Debugging and Monitoring"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../atomic-structure/" class="btn btn-neutral float-right" title="Atomic Structure and Design">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/cfpb/consumerfinance.gov" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../debugging-monitoring/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../atomic-structure/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
