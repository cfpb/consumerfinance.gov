<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Caching - consumerfinance.gov</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  <link href="../css/overrides.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Caching";
    var mkdocs_page_input_path = "caching.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> consumerfinance.gov</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../installation/">Installation</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Running this Project</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../running-virtualenv/">Running in a Virtual Environment</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../running-docker/">Running in Docker</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../debugging-monitoring/">Debugging and Monitoring</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../deployment/">Artifacts and Deployment</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Pages and Components</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../atomic-structure/">Atomic Structure and Design</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../editing-components/">Creating and Editing Components</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../debugging-templates/">Debugging Templates</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../migrations/">Django and Wagtail Migrations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../forms-in-wagtail/">Forms in Wagtail Page Context</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../wagtail-pages/">Wagtail Pages</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Supporting Features</span></p>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Caching</a>
    <ul class="current">
    
        <ul>
        
            <li><a class="toctree-l4" href="#akamai">Akamai</a></li>
        
            <li><a class="toctree-l4" href="#django-caching">Django caching</a></li>
        
        </ul>
    

    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../feature-flags/">Feature Flags</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../filterable-lists/">Filterable Lists</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../page-search/">Page Search</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../site-search/">Site Search</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../translation/">Translation</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Testing</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../javascript-unit-tests/">JavaScript Unit Testing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../python-unit-tests/">Python Unit Testing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../functional-testing/">Functional Testing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../profiling-django/">Profiling Django</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../other-front-end-testing/">Other Front-end Testing</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Contributing</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../branching-merging/">Branching and Merging</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../contributing-docs/">Contributing to the Docs</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../related-projects/">Related Projects</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../development-tips/">Development Tips</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../github-actions/">How We Use GitHub Actions</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">APIs and Data</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../ask-cfpb/">Ask CFPB</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../consumer-complaint-database/">Consumer Complaints</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../housing-counselor-tool/">Find a Housing Counselor Tool</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../website-feedback/">Website Feedback</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">consumerfinance.gov</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Supporting Features &raquo;</li>
        
      
    
    <li>Caching</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/cfpb/consumerfinance.gov/edit/master/docs/caching.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="caching">Caching<a class="headerlink" href="#caching" title="Permanent link">¶</a></h1>
<h3 id="akamai">Akamai<a class="headerlink" href="#akamai" title="Permanent link">¶</a></h3>
<p>We use <a href="https://www.akamai.com/">Akamai</a>, a content delivery network, to cache the entirety of <a href="https://www.consumerfinance.gov/">www.consumerfinance.gov</a> (but not our development servers). We invalidate any given page in Wagtail when it is published or unpublished (by hooking up the custom class <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/v1/models/akamai_backend.py"><code>AkamaiBackend</code></a> to <a href="http://docs.wagtail.io/en/v2.0.1/reference/contrib/frontendcache.html">Wagtail's frontend cache invalidator</a>. By default, we clear the Akamai cache any time we deploy.</p>
<p>There are certain pages that do not live in Wagtail or are impacted by changes on another page (imagine our <a href="https://www.consumerfinance.gov/about-us/newsroom/">newsroom page</a> that lists titles of other pages) or another process (imagine data from Socrata gets updated) and thus will display outdated content until the page's time to live (TTL) has expired, a deploy has happened, or if someone manually invalidates that page. Our default TTL is 24 hours.</p>
<h4 id="checking-the-cache-state-of-a-url">Checking the cache state of a URL<a class="headerlink" href="#checking-the-cache-state-of-a-url" title="Permanent link">¶</a></h4>
<p>To get the current cache state of a URL (perhaps to see if that URL has been invalidated), you can use the following <code>curl</code> command to check the <code>X-Cache</code> header:</p>
<pre class="highlight"><code class="language-shell">curl -sI -H &quot;Pragma: akamai-x-cache-on&quot; https://beta.consumerfinance.gov | grep &quot;X-Cache&quot;</code></pre>

<p>It will return something like:</p>
<pre class="highlight"><code>X-Cache: TCP_HIT from a23-46-239-53.deploy.akamaitechnologies.com (AkamaiGHost/9.5.4-24580776) (-)</code></pre>

<p>The possible cache state values are:</p>
<ul>
<li><code>TCP_HIT</code>: The object was fresh in cache and object from disk cache.</li>
<li><code>TCP_MISS</code>: The object was not in cache, server fetched object from origin.</li>
<li><code>TCP_REFRESH_HIT</code>: The object was stale in cache and we successfully refreshed with the origin on an If-modified-Since request.</li>
<li><code>TCP_REFRESH_MISS</code>: Object was stale in cache and refresh obtained a new object from origin in response to our IF-Modified-Since request.</li>
<li><code>TCP_REFRESH_FAIL_HIT</code>: Object was stale in cache and we failed on refresh (couldn't reach origin) so we served the stale object.</li>
<li><code>TCP_IMS_HIT</code>: IF-Modified-Since request from client and object was fresh in cache and served.</li>
<li><code>TCP_NEGATIVE_HIT</code>: Object previously returned a "not found" (or any other negatively cacheable response) and that cached response was a hit for this new request.</li>
<li><code>TCP_MEM_HIT</code>: Object was on disk and in the memory cache. Server served it without hitting the disk.</li>
<li><code>TCP_DENIED</code>: Denied access to the client for whatever reason.</li>
<li><code>TCP_COOKIE_DENY</code>: Denied access on cookie authentication (if centralized or decentralized authorization feature is being used in config).</li>
</ul>
<h3 id="django-caching">Django caching<a class="headerlink" href="#django-caching" title="Permanent link">¶</a></h3>
<p>Starting in December 2017, we use <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/v1/jinja2tags/fragment_cache.py">template fragment caching</a> to cache all or part of a template.  It is enabled on our "post previews", snippets of a page that we display on results of filterable pages (e.g. <a href="https://consumerfinance.gov/about-us/blog">our blog page</a> &amp; <a href="https://www.consumerfinance.gov/data-research/research-reports/">research &amp; reports</a>).</p>
<p>It can easily be enabled on other templates. See <a href="https://github.com/cfpb/consumerfinance.gov/pull/3663/files">this PR</a> as an example of the code that would need to be introduced to cache a new fragment.</p>
<p>When a page gets published, it will update the post preview cache for that particular page.  However, if there are code changes that impact the page's content, or the post preview template itself gets updated, the entire post preview cache will need to be manually cleared. Clearing this particular cache could be an option when deploying, as it is with Akamai, but should not be a default since most deploys wouldn't impact the code in question.  Currently, the manual way to do this would be to run the following from a production server's django shell:</p>
<pre class="highlight"><code>from django.core.cache import caches

caches['post_preview'].clear()</code></pre>

<p>To run the application locally with caching for post previews enabled, run <code>ENABLE_POST_PREVIEW_CACHE=1 ./runserver.sh</code>
Alternatively, add this variable to your <code>.env</code> if you generally want it enabled locally.</p>
<p>Due to the impossibility/difficulty/complexity of caching individual Wagtail blocks (they are not serializable) and invalidating content that does not have some type of <code>post_save</code> hook (e.g. Taggit models), we have started with caching segments that are tied to a Wagtail page (which can be easily invalidated using the <code>page_published</code> Wagtail signal), hence the post previews. With more research or improvements to these third-party libraries, it is possible we could expand Django-level caching to more content.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../feature-flags/" class="btn btn-neutral float-right" title="Feature Flags">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../wagtail-pages/" class="btn btn-neutral" title="Wagtail Pages"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/cfpb/consumerfinance.gov/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../wagtail-pages/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../feature-flags/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
