<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Feature Flags - consumerfinance.gov</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../css/overrides.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Feature Flags";
        var mkdocs_page_input_path = "feature-flags.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> consumerfinance.gov
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation/">Setup</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Running this Project</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../running-virtualenv/">Running in a Virtual Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../running-docker/">Running in Docker</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../debugging-monitoring/">Debugging and Monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../deployment/">Artifacts and Deployment</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Pages and Components</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../atomic-structure/">Atomic Structure and Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../editing-components/">Creating and Editing Components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../debugging-templates/">Debugging Templates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../migrations/">Django and Wagtail Migrations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wagtail-pages/">Wagtail Pages</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Supporting Features</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../caching/">Caching</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Feature Flags</a>
    <ul class="current">
    
        <ul>
        
            <li><a class="toctree-l4" href="#adding-a-flag">Adding a flag</a></li>
        
            <li><a class="toctree-l4" href="#checking-a-flag">Checking a flag</a></li>
        
            <li><a class="toctree-l4" href="#enabling-a-flag">Enabling a flag</a></li>
        
            <li><a class="toctree-l4" href="#satellite-apps">Satellite apps</a></li>
        
            <li><a class="toctree-l4" href="#hygiene">Hygiene</a></li>
        
        </ul>
    

    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../filterable-lists/">Filterable Lists</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../page-search/">Page Search</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../site-search/">Site Search</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../translation/">Translation</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Testing</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../javascript-unit-tests/">JavaScript Unit Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../python-unit-tests/">Python Unit Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../functional-testing/">Functional Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../profiling-django/">Profiling Django</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../other-front-end-testing/">Other Front-end Testing</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Contributing</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../branching-merging/">Branching and Merging</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../contributing-docs/">Contributing to the Docs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../related-projects/">Related Projects</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development-tips/">Development Tips</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../github-actions/">How We Use GitHub Actions</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">APIs and Data</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../ask-cfpb/">Ask CFPB</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../consumer-complaint-database/">Consumer Complaints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../housing-counselor-tool/">Find a Housing Counselor Tool</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">consumerfinance.gov</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Supporting Features &raquo;</li><li>Feature Flags</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/cfpb/consumerfinance.gov/edit/master/docs/feature-flags.md"
          class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="feature-flags">Feature flags<a class="headerlink" href="#feature-flags" title="Permanent link">Â¶</a></h1>
<p>Feature flags are implemented using our <a href="https://github.com/cfpb/django-flags">Django-Flags</a> and <a href="https://github.com/cfpb/wagtail-flags">Wagtail-Flags</a> apps. The <a href="https://cfpb.github.io/django-flags">Django-Flags documentation</a> contains an overview of feature flags and how to use them and the <a href="https://github.com/cfpb/wagtail-flags/blob/main/README.md">Wagtail-Flags README</a> describes how to add feature flag conditions in the Wagtail admin.</p>
<p>This document covers how to add and use feature flags with consumerfinance.gov and the conventions we have around their use.</p>
<ul>
<li><a href="#adding-a-flag">Adding a flag</a></li>
<li><a href="#checking-a-flag">Checking a flag</a><ul>
<li><a href="#in-templates">In templates</a><ul>
<li><a href="#jinja2">Jinja2</a></li>
<li><a href="#django">Django</a></li>
</ul>
</li>
<li><a href="#in-code">In code</a></li>
<li><a href="#in-urls">In URLs</a></li>
</ul>
</li>
<li><a href="#enabling-a-flag">Enabling a flag</a><ul>
<li><a href="#hard-coded-conditions">Hard-coded conditions</a></li>
<li><a href="#database-conditions">Database conditions</a></li>
</ul>
</li>
<li><a href="#satellite-apps">Satellite apps</a></li>
<li><a href="#hygiene">Hygiene</a></li>
</ul>
<h2 id="adding-a-flag">Adding a flag<a class="headerlink" href="#adding-a-flag" title="Permanent link">Â¶</a></h2>
<p>Feature flags are defined in code in the <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/cfgov/settings/base.py#L562"><code>cfgov/settings/base.py</code></a> file as part of the <code>FLAGS</code> setting. Each flag consists of a single string and a Python list of its hard-coded conditions (see <a href="#enabling-a-flag">Enabling a flag</a> below).</p>
<pre class="highlight"><code class="language-python">FLAGS = {
    # Beta banner, seen on beta.consumerfinance.gov
    # When enabled, a banner appears across the top of the site proclaiming
    # "This beta site is a work in progress."
    'BETA_NOTICE': [],
}</code></pre>
<p>By convention our flag names are all uppercase, with underscores instead of whitespace. A comment is expected above each flag with a short description fo what happens when it is enabled.</p>
<h2 id="checking-a-flag">Checking a flag<a class="headerlink" href="#checking-a-flag" title="Permanent link">Â¶</a></h2>
<p>Flags can be checked either in Python code or in Django or Jinja2 template files. See the full <a href="https://github.com/cfpb/wagtail-flags/blob/main/README.md#api">Wagtail Flags API is documented </a> for more information.</p>
<h3 id="in-templates">In templates<a class="headerlink" href="#in-templates" title="Permanent link">Â¶</a></h3>
<h4 id="jinja2">Jinja2<a class="headerlink" href="#jinja2" title="Permanent link">Â¶</a></h4>
<p>Most of consumerfinance.gov's templates are Jinja2. In these templates, two template functions are provided, <code>flag_enabled</code> and <code>flag_disabled</code>. Each takes a flag name as its first argument and request` object as the second.</p>
<p><code>flag_enabled('MY_FLAG')</code> will return <code>True</code> if the conditions under which <code>MY_FLAG</code> is enabled <strong>are</strong> met.</p>
<p><code>flag_disabled('MY_FLAG')</code> will return <code>True</code> if the conditions under which <code>MY_FLAG</code> is enabled <strong>are not</strong> met.</p>
<p>See <a href="#enabling-a-flag">Enabling a flag</a> below for more on flag conditions.</p>
<p>An example is <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/jinja2/v1/_includes/organisms/header.html#L28-L41">the <code>BETA_NOTICE flag</code> as implemented in <code>header.html</code></a>:</p>
<pre class="highlight"><code class="language-jinja">{% if flag_enabled('BETA_NOTICE') %}
&lt;div class="m-global-banner"&gt;
    &lt;div class="wrapper
                wrapper__match-content
                o-expandable
                o-expandable__expanded"&gt;
        &lt;div class="m-global-banner_head"&gt;
            &lt;span class="cf-icon
                         cf-icon-error-round
                         m-global-banner_icon"&gt;&lt;/span&gt;
            This beta site is a work in progress.
        &lt;/div&gt;
        â¦
    &lt;/div&gt;
&lt;/div&gt;
{% endif %}</code></pre>
<h4 id="django">Django<a class="headerlink" href="#django" title="Permanent link">Â¶</a></h4>
<p>In Django templates (used in Satellite apps and the Wagtail admin), two template functions are provided <code>flag_enabled</code> and <code>flag_disabled</code> once the <code>feature_flags</code> template tag library is loaded.</p>
<p><code>flag_enabled 'MY_FLAG'</code> will return <code>True</code> if the conditions under which <code>MY_FLAG</code> is enabled <strong>are</strong> met.</p>
<p><code>flag_disabled 'MY_FLAG'</code> will return <code>True</code> if the conditions under which <code>MY_FLAG</code> is enabled <strong>are not</strong> met.</p>
<p>See <a href="#enabling-a-flag">Enabling a flag</a> below for more on flag conditions.</p>
<p>The <code>BETA_NOTICE</code> <a href="#jinja2">Jinja2</a> example above when implemented with Django templates would look like this:</p>
<pre class="highlight"><code class="language-django">{% load feature_flags %}

{% flag_enabled 'BETA_NOTICE' as beta_flag %}
{% if beta_flag %}
&lt;div class="m-global-banner"&gt;
    &lt;div class="wrapper
                wrapper__match-content
                o-expandable
                o-expandable__expanded"&gt;
        &lt;div class="m-global-banner_head"&gt;
            &lt;span class="cf-icon
                         cf-icon-error-round
                         m-global-banner_icon"&gt;&lt;/span&gt;
            This beta site is a work in progress.
        &lt;/div&gt;
        â¦
    &lt;/div&gt;
&lt;/div&gt;
{% endif %}</code></pre>
<h3 id="in-code">In code<a class="headerlink" href="#in-code" title="Permanent link">Â¶</a></h3>
<p>In Python code three functions are available for checking feature flags, <code>flag_state</code>, <code>flag_enabled</code>, and <code>flag_disabled</code>. The Python API is slightly different from the <a href="#jinja2">Jinja2</a> or <a href="#django">Django template</a> API, in that flag conditions can take more potential arguments than requests, and thus flags are more flexible when checked in Python (in and outside a request cycle).</p>
<p>See the <a href="https://cfpb.github.io/django-flags/api/state/">Django-Flags flag state API documentation for more</a>.</p>
<p>Additionally two decorators, <code>flag_check</code> and <code>flag_required</code>, are provided for wrapping views (and another functions) in a feature flag check.  See the <a href="https://cfpb.github.io/django-flags/api/decorators/">Django-Flags flag decorators API documentation for more</a>.</p>
<h3 id="in-urls">In URLs<a class="headerlink" href="#in-urls" title="Permanent link">Â¶</a></h3>
<p>There are two ways to flag Django URL patterns in <code>urls.py</code>: with <code>flagged_url()</code> in place of <code>url()</code> for a single pattern, or with the <code>flagged_urls()</code> context manager for multiple URLs.</p>
<p><code>flagged_url(flag_name, regex, view, kwargs=None, name=None, state=True, fallback=None)</code> works exactly like <code>url()</code> except it takes a flag name as its first argument. If the flag's state matches the given <code>state</code>, the URL pattern will be served from the given <code>view</code>; if not, and <code>fallback</code> is given, the <code>fallback</code> will be used.</p>
<p>An example is <a href="https://github.com/cfpb/consumerfinance.gov/blob/4c3521e967abc5a35fc42566ae409d6ba008f81e/cfgov/cfgov/urls.py#L204-L210">our <code>WAGTAIL_ABOUT_US</code> flag</a>:</p>
<pre class="highlight"><code class="language-python">flagged_url('WAGTAIL_ABOUT_US',
            r'^about-us/$',
            lambda req: ServeView.as_view()(req, req.path),
            fallback=SheerTemplateView.as_view(
                template_name='about-us/index.html'),
            name='about-us'),</code></pre>
<p>Ignoring the <code>view</code> being a <code>lambda</code> for now (see <a href="#flagging-wagtail-urls">Flagging Wagtail URLs below</a>), this URL will be served via Wagtail if <code>WAGTAIL_ABOUT_US</code>'s conditions are <code>True</code>, and from a <code>TemplateView</code> if its conditions are <code>False</code>.</p>
<p>If you need to flag multiple URLs with the same flag, you can use the <code>flagged_urls()</code> context manager.</p>
<p><code>with flagged_urls(flag_name, state=True, fallback=None) as url</code> provides a context in which the returned <code>url()</code> function can be used in place of the Django <code>url()</code> function in patterns and those patterns will share the same feature flag, state, and fallback.</p>
<p>An example is <a href="https://github.com/cfpb/consumerfinance.gov/blob/3cd79689aac7e22e3c2f07373a7db7f2fbbed304/cfgov/cfgov/urls.py#L405-L433">our <code>WAGTAIL_ASK_CFPB</code> flag</a>:</p>
<pre class="highlight"><code class="language-python">with flagged_urls('WAGTAIL_ASK_CFPB') as url:
    ask_patterns = [
        url(r'^(?i)ask-cfpb/([-\w]{1,244})-(en)-(\d{1,6})/?$',
            view_answer,
            name='ask-english-answer'),
        url(r'^(?i)obtener-respuestas/([-\w]{1,244})-(es)-(\d{1,6})/?$',
            view_answer,
            name='ask-spanish-answer'),
        â¦
    ]

urlpatterns += ask_patterns</code></pre>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not attempt to use <code>flag_check</code> or any flag state-checking functions in <code>urls.py</code>. Because they will be evaluated on import of <code>urls.py</code> they will attempt to access the Django FlagState model before it is ready and will error.</p>
</div>
<h4 id="flagging-wagtail-urls">Flagging Wagtail URLs<a class="headerlink" href="#flagging-wagtail-urls" title="Permanent link">Â¶</a></h4>
<p>Wagtail views in <code>flagged_url</code> with a Django view as fallback (or vice-versa) can be a bit awkward. Django views are typically called with <code>request</code> as the first argument, and Wagtail's <code>serve</code> view takes both the request and the path. To get around this, in <code>flagged_url</code> we typically use a <code>lambda</code> for the view:</p>
<pre class="highlight"><code class="language-python">lambda req: ServeView.as_view()(req, req.path)</code></pre>
<p>This lambda takes the request and calls the <a href="https://github.com/cfpb/wagtail-sharing">Wagtail-Sharing</a> <code>ServeView</code> (which we're using in place of <code>wagtail.core.views.serve</code>).</p>
<h2 id="enabling-a-flag">Enabling a flag<a class="headerlink" href="#enabling-a-flag" title="Permanent link">Â¶</a></h2>
<p>Feature flags are enabled based on a set of conditions that are given either in the Django settings files (in <code>cfgov/cfgov/settings/</code>) or in the Django or Wagtail admin. Multiple conditions can be given, both in settings and in the admin, and if any condition is satisfied a flag is enabled.</p>
<p><a href="https://cfpb.github.io/django-flags/conditions/">A list of available conditions and how to use them is available in the Django-Flags documentation</a>.</p>
<h3 id="hard-coded-conditions">Hard-coded conditions<a class="headerlink" href="#hard-coded-conditions" title="Permanent link">Â¶</a></h3>
<p>Conditions that are defined in the Django settings are hard-coded, and require a change to files in consumerfinance.gov, a new tagged release, and new deployment to change. These conditions should be used for flags that are relatively long-lasting and that can require a round-trip through the release and deployment process to change.</p>
<p>When <a href="#adding-a-flag">adding a flag</a> to the Django settings the flag's dictionary of conditions can contain a condition name and value that must be satisfied for the flag to be enabled. The nature of that value changes depending on the condition type. <a href="https://cfpb.github.io/django-flags/conditions/">See the Django-Flags conditions documentation</a> for more on individual conditions.</p>
<p>There is a simple <code>boolean</code> condition that is either <code>True</code> or <code>False</code>, and if it is <code>True</code> the flag is enabled and if it is <code>False</code> the flag is disabled. If we want to always turn the <code>BETA_NOTICE</code> flag on in settings with a <code>boolean</code> condition, that would look like this:</p>
<pre class="highlight"><code class="language-python">FLAGS = {
    # Beta banner, seen on beta.consumerfinance.gov
    # When enabled, a banner appears across the top of the site proclaiming
    # "This beta site is a work in progress."
    'BETA_NOTICE': [
        {
            'condition': 'boolean',
            'value': True,
        },
    ],
}</code></pre>
<h3 id="database-conditions">Database conditions<a class="headerlink" href="#database-conditions" title="Permanent link">Â¶</a></h3>
<p>Conditions that are managed via the Wagtail or Django admin are stored in the database. These conditions can be changed in real-time and do not require any code changes or release and deployment to change (presuming the code that uses the feature flag is in place).</p>
<p>To view, delete, and add database conditions, navigate to "Settings &gt; Flags" in the Wagtail admin.</p>
<p><img alt="settings, flags" src="../img/settings_flags.gif" /></p>
<p>Once in the flag settings, you'll have a list of all flags and their statuses.</p>
<p><img alt="flag list" src="../img/flags_list.png" /></p>
<p>Select a flag to see its conditions.</p>
<p><img alt="flag details" src="../img/flag_details.png" /></p>
<p>Existing database conditions can be edited or deleted here.</p>
<p>To create a new database condition, select "Add a condition". As with <a href="#hard-coded-conditions">hard-coded conditions</a>, to create a database condition you must select which condition type you would like to use and give it a value that must be satisfied for the flag to be enabled.</p>
<p><img alt="creating a condition" src="../img/flag_conditions.gif" /></p>
<p>Database conditions can only be set for flags that exist in the Django settings.</p>
<h2 id="satellite-apps">Satellite apps<a class="headerlink" href="#satellite-apps" title="Permanent link">Â¶</a></h2>
<p>Feature flags can be used in satellite apps in exactly the same way they are used in consumerfinance.gov. An example is <a href="https://github.com/cfpb/complaint/blob/9985b4ea4ce5c6e9b55d57228520a92a26152565/complaintdatabase/views.py#L31-L36">the use of a feature flagged template choice in the complaintdatabase app</a>.</p>
<h2 id="hygiene">Hygiene<a class="headerlink" href="#hygiene" title="Permanent link">Â¶</a></h2>
<p>Most feature flags are no longer needed once a feature is launched. Follow these steps to remove a flag when its job is done:</p>
<ul>
<li>Create a pull request that deletes the flag from settings, if it was declared there, and removes any related code and tests that referenced the flag.</li>
<li>After the changes are merged and deployed to production, check <code>Settings ==&gt; Flags</code> in Wagtail (<code>/admin/flags/</code>) to see if the removed flag is still listed. If so, the flag has been saved in our database. Select the flag, click the DELETE FLAG button at top right, and then choose YES, DELETE IT.</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../caching/" class="btn btn-neutral float-left" title="Caching"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../filterable-lists/" class="btn btn-neutral float-right" title="Filterable Lists">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/cfpb/consumerfinance.gov" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../caching/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../filterable-lists/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
