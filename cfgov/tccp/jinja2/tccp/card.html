{% extends 'v1/layouts/layout-2-1.html' %}

{% from 'tccp/includes/data_published.html' import data_published %}
{% from 'tccp/includes/fields.html' import apr, apr_range, currency, lower_first_letter, oxfordize %}
{% from 'v1/includes/organisms/expandable.html' import expandable with context %}
{% import 'v1/includes/molecules/notification.html' as notification with context %}

{% block title -%}
    {{ card.institution_name }} {{ card.product_name }}
    | Consumer Financial Protection Bureau
{%- endblock title %}

{% block javascript scoped %}
    {{ super() }}
    <script src="{{ static( 'js/routes/on-demand/expandable.js' ) }}"></script>
    <script src="{{ static( 'apps/tccp/js/index.js' ) }}"></script>
{% endblock %}

{% block css %}
    {{ super() }}
    <link rel="stylesheet" href="{{ static('apps/tccp/css/main.css') }}">
{% endblock %}

{% block content_main %}
<div class="block block__flush-top">

    <div class="eyebrow">{{ card.institution_name }}</div>
    <h1>{{ card.product_name }}</h1>
    {% set credit_tiers = [
        ("No credit score", "No score"),
        ("619 or less", "Below 619"),
        ("620 to 719", "620-719"),
        ("720 or greater", "720+")
    ] %}
    <div class="o-card-details-section o-card-details-section--introduction">
        {# TODO: Need to make this more accessible for screen readers #}
        <div class="m-credit-tier-chart">
            {% for tier in credit_tiers %}
                {% if tier[0] in card.targeted_credit_tiers | string %}
                    {% set targeted_tier = true %}
                {% else %}
                    {% set targeted_tier = false %}
                {% endif %}
                <div class="m-credit-tier-chart__tier m-credit-tier-chart__tier{{ '--selected' if targeted_tier else '--unselected' }}">
                    <span class="m-credit-tier-chart__icon">
                        {% if targeted_tier %}
                            {{ svg_icon('approved-round') if targeted_tier }}
                        {% else %}
                            &nbsp;
                        {% endif %}
                    </span>
                    <span class="m-credit-tier-chart__label">{{ tier[1] }}</span>
                </div>
            {% endfor %}
        </div>
        <div class="h4 u-mt5">
            Recommended credit scores
        </div>
        {% if card.availability_of_credit_card_plan == "One State/Territory" %}
            {% set availability = "single_state" %}
            {% set available_states = [card.state] %}
        {% elif card.availability_of_credit_card_plan == "Regional" %}
            {% set availability = "multiple_states" %}
            {% set available_states = card.state_multiple %}
        {% else %}
            {% set availability = "nationwide" %}
            {% set available_states = none %}
        {% endif %}
        <div class="{{ 'u-mt45 u-mb45' if availability == 'multiple_states' or card.requirements_for_opening else 'u-mt30 u-mb30' }}">
            <div class="m-location-requirements">
                <div class="h2 u-mb0">
                    {% if availability == "nationwide" %}
                        Nationwide
                    {% elif availability == "single_state" %}
                        {{ state_lookup[available_states[0]] ~ ' only' }}
                    {% elif availability == "multiple_states" and not card.pertains_to_specific_counties %}
                        State-by-state
                    {% else %}
                        County-by-county
                    {% endif %}
                </div>
                <div class="h4 u-mt0">
                    Availability
                </div>
            </div>
            {% if availability == "multiple_states" or card.geographic_restrictions is not none %}
                <ul>
                    {% if availability == "multiple_states" %}
                        <li>
                            To apply, you must live in
                            {{ 'certain counties in ' if card.pertains_to_specific_counties }}
                            {%- set states = [] -%}
                            {%- for state in available_states -%}
                                {%- do states.append(state_lookup[state]) -%}
                            {%- endfor -%}
                            {{ oxfordize(states) }}
                        </li>
                    {% endif %}
                    {% if card.geographic_restrictions is not none %}
                        <li>{{ card.geographic_restrictions }}</li>
                    {% endif %}
                </ul>
            {% endif %}
            {% if card.professional_affiliation is not none or card.other is not none %}
                <div class="h4 u-mt15">Other requirements for applying</div>
                <ul>
                    {% for requirement in [
                        card.professional_affiliation,
                        card.other
                    ] %}
                        {% if requirement %}
                            <li>{{ requirement }}</li>
                        {% endif %}
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
        <div class="o-contact-info">
            {% if card.website_for_consumer %}
                {# Some issuers submitted more than one URL for a card, always
                    separated by a space. To catch those, we'll make a list and
                    render a link for each URL. #}
                {% set urls = card.website_for_consumer.split() %}
                {% for url in urls %}
                    {# TODO: Make this into a custom filter instead of rpartition #}
                    {% with value = {
                        "url": url,
                        "text": url.rpartition("//")[-1].partition("/")[0]
                            | replace('www.', '')}
                    %}
                        {% include "v1/includes/molecules/contact-hyperlink.html" %}
                    {% endwith %}
                {% endfor %}
            {% endif %}
            {% if card.telephone_number_for_consumers %}
                {# TODO: Make this into a custom filter instead of this terribleness #}
                {% set phone_number = card.telephone_number_for_consumers | replace('-', '') | replace('(', '') | replace(')', '') | replace(' ', '') %}
                {% if phone_number.startswith('1') %}
                    {% set phone_number = phone_number[1:] %}
                {% endif %}
                {% with value = {"phones": [{"number": phone_number}]} %}
                    {% include "v1/includes/molecules/contact-phone.html" %}
                {% endwith %}
            {% endif %}
        </div>
    </div>
    {{ data_published(card.report_date) }}

    {% if card.secured_card %}
        <div class="u-mt30 u-mb30">
            {{ notification.render(
                "warning",
                true,
                "This is a secured card",
                "You will have to pay a security deposit before using this card
                and will only be able to make purchases or get cash advances up
                to the amount of that deposit."
            ) }}
        </div>
    {% endif %}

    <div class="o-card-details-section">
        <h2 class="h3 u-mb15">
            {{ svg_icon("cart-round") }}
            Making purchases
        </h2>
        {# TODO: Unify ratings code with results list view #}
        {% set purchase_apr_rating_labels = [
            'less', 'average', 'more'
        ] %}
        {% set purchase_apr_ratings = [
            card.purchase_apr_poor_rating,
            card.purchase_apr_good_rating,
            card.purchase_apr_great_rating
        ] %}
        {% set purchase_aprs = [
            (card.purchase_apr_poor_min, card.purchase_apr_poor_max),
            (card.purchase_apr_good_min, card.purchase_apr_good_max),
            (card.purchase_apr_great_min, card.purchase_apr_great_max),
        ] %}
        {% if card.purchase_apr_offered
            and card.purchase_apr_poor_min is none
            and card.purchase_apr_poor_max is none
            and card.purchase_apr_good_min is none
            and card.purchase_apr_good_max is none
            and card.purchase_apr_great_min is none
            and card.purchase_apr_great_max is none
        %}
            {% set purchase_apr_data_incomplete = true %}
        {% else %}
            {% set purchase_apr_data_incomplete = false %}
        {% endif %}
        {% if card.purchase_apr_offered and not purchase_apr_data_incomplete %}
            {# How top-line APR displays if the card has:
                - Min and max APRs: "19.49% - 31.99% purchase APR"
                - No min and max but a median: "29.74% median purchase APR"
                - Single APR for everyone: "24.90% purchasae APR"
            #}
            <div class="h2 u-mb0 u-mt15">
                {% if card.purchase_apr_min is not none
                    and card.purchase_apr_max is not none
                %}
                    {{ apr_range(card.purchase_apr_min, card.purchase_apr_max) }}
                {% elif card.purchase_apr_median is not none %}
                    {{ apr(card.purchase_apr_median) }}
                {% endif %}
            </div>
            <div class="h4 u-mt0">
                {% if card.purchase_apr_min is not none
                    and card.purchase_apr_max is not none
                %}
                    Purchase APR
                {% elif card.purchase_apr_median is not none %}
                    Median purchase APR
                {% endif %}
            </div>
            <p>
                {{'Your APR will be based on your credit score. ' if card.purchase_apr_vary_by_credit_tier }}
                You’ll only know your exact APR if you are approved for the
                card. Here are average APRs for different credit scores for this
                card:
            </p>
            <table class="o-table o-table--apr">
                <thead>
                    <tr>
                        <th>Credit score</th>
                        <th>Median purchase APR</th>
                        <th>Comparison to other cards</th>
                    </tr>
                </thead>
                <tbody>
                    {% for purchase_apr in purchase_aprs %}
                        <tr>
                            <td>{{ credit_tiers[loop.index][1] }}</td>
                            <td>{{ apr_range(purchase_apr[0], purchase_apr[1]) }}</td>
                            <td>
                                {% if purchase_apr_ratings[loop.index0] is not none %}
                                    {% set label = purchase_apr_rating_labels[purchase_apr_ratings[loop.index0]] %}
                                    <span class="a-credit-card-apr-rating--{{ label }}">
                                        {%- for i in range(purchase_apr_ratings[loop.index0] + 1) %}
                                            {{ svg_icon("dollar-round") }}
                                        {% endfor -%}

                                        Pay {{ label }} interest
                                    </span>
                                {% else %}
                                    Not targeted for these credit scores
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <p>
                The purchase APR is
                {% if 'V' in card.index %}
                    variable, meaning it can go up or down based on an index. You can
                    <a href="/ask-cfpb/what-is-the-difference-between-a-fixed-apr-and-a-variable-apr-en-45/">learn
                    more about variable APRs in general</a> or expand this section to
                    learn more about the index this APR is based on.
                {% else %}
                    fixed, meaning it will not go up or down with changes to an index
                    but may still change. You can
                    <a href="/ask-cfpb/what-is-the-difference-between-a-fixed-apr-and-a-variable-apr-en-45/">learn
                    more about fixed APRs.</a>
                {% endif %}
            </p>
        {% elif card.purchase_apr_offered and purchase_apr_data_incomplete %}
            <p>The issuer did not submit information about purchase APR.</p>
        {% else %}
            <p>This card does not charge interest on purchases.</p>
        {% endif %}
        {% if card.introductory_apr_offered %}
            <div class="h3 u-mb0 u-mt30">
                {% if card.intro_apr_min is not none
                    and card.intro_apr_max is not none
                %}
                    {{ apr_range(card.intro_apr_min, card.intro_apr_max) }}
                {% elif card.intro_apr_median is not none %}
                    {{ apr(card.intro_apr_median) }}
                {% endif %}
                for
                {{ '%g' | format(card.median_length_of_introductory_apr) }} months
            </div>
            <div class="u-mb15">
                {% if card.intro_apr_min is not none
                    and card.intro_apr_max is not none
                %}
                    Introductory APR
                {% elif card.intro_apr_median is not none %}
                    Median introductory APR
                {% endif %}
            </div>
            {% if card.introductory_apr_vary_by_credit_tier %}
            <p>
                Your introductory APR will be based on your credit score.
                You’ll only know your exact APR if you are approved for the
                card. Here are average APRs for different credit scores for this
                card:
            </p>
            <table class="o-table o-table--apr">
                <thead>
                    <tr>
                        <th>Credit score</th>
                        <th>Median intro APR</th>
                    </tr>
                </thead>
                <tbody>
                    {% for intro_apr in [
                        card.intro_apr_poor,
                        card.intro_apr_good,
                        card.intro_apr_great
                    ] %}
                        <tr>
                            <td>{{ credit_tiers[loop.index][1] }}</td>
                            <td>{{ apr(intro_apr) }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% elif card.intro_apr_median is not none
                and card.intro_apr_min != card.intro_apr_max %}
                <p>
                    You’ll only know your exact APR if you are approved for the
                    card. The median APR for this card is
                    {{ apr(card.intro_apr_median) }}.
                </p>
            {% endif %}
            <p>
                With introductory APR offers, you have to keep track of
                how you are paying off that balance within the promotional
                period, or you could end up owing more in interest than the
                original purchase amount.
            </p>
        {% endif %}
        <div class="o-additional-details">
            {% call() expandable({
                'label': 'Transaction fees, charges, and other details',
                'is_bordered': true,
                'is_expanded': false,
                'is_midtone': false
            }) %}
                <dl class="m-list m-list__card-details">
                    <dt>Foreign transaction fee</dt>
                    <dd>
                        {# How foreign transaction fees display:
                            - No fee: "None"
                            - Dollar amount: "$3"
                            - Percentage: "3.00%"
                            - Calculation: "Whatever text was submitted"
                            - With minimum fee amount: add "($0.50 minimum)" to end
                            - Dollar or percentage and calculation: "3.00% (text)"
                        #}
                        {% if card.foreign_transaction_fees %}
                            {{ currency(card.foreign_transaction_fee_dollars) ~
                                ' per purchase' if card.foreign_transaction_fee_dollars
                                is not none
                            }}
                            {{ apr(card.foreign_transaction_fee_percentage) ~
                                ' of each purchsae' if
                                card.foreign_transaction_fee_percentage is not none
                            -}}
                            {% if card.minimum_foreign_transaction_fee_amount is not none %}
                                {{ '(' ~ currency(card.minimum_foreign_transaction_fee_amount)
                                    ~ ' minimum)' if card.minimum_foreign_transaction_fee_amount
                                    is not none
                                }}
                            {%- endif %}
                            {%- if card.foreign_transaction_fee_calculation %}
                                {{- '; ' if card.foreign_transaction_fee_dollars is not none
                                    or card.foreign_transaction_fee_percentage is not none
                                -}}
                                {{- card.foreign_transaction_fee_calculation -}}
                            {% endif %}
                        {% else %}
                            None
                        {% endif %}
                    </dd>
                    <dt>Minimum finance charge</dt>
                    <dd>
                        {% if card.minimum_finance_charge %}
                            A minimum interest payment of
                            {{ currency(card.minimum_finance_charge_dollars) }}
                            is required to avoid additional fees
                        {% else %}
                            No minimum interest payment is required to avoid additional
                            fees
                        {% endif %}
                    </dd>
                    <dt>Grace period</dt>
                    <dd>
                        {{ card.grace_period ~ ' days until interest begins to accrue on
                            purchases' if grace_period_offered else 'None, interest
                            begins accruing on purchases immediately'
                        }}
                    </dd>
                    <dt>Balance computation method</dt>
                    <dd>
                        {% if 'Other' is not in card.balance_computation_method %}
                            Monthly interest is calculated based on your
                            {{ lower_first_letter(card.balance_computation_method | join) }}
                        {% else %}
                            {{ card.balance_computation_method_details }}
                        {% endif %}
                    </dd>
                    {# No cards in the June 2023 data have this fee, so we'll handle it
                        with a very simple yes/no to future-proof it just in case #}
                    {% if card.purchase_transaction_fees %}
                        <dt>Purchase transaction fee</dt>
                        <dd>Yes</dd>
                    {% endif %}
                    {% if card.purchase_apr_index %}
                        <dt>Purchase APR index</dt>
                        <dd>
                            The purchase APR varies depending on the value of the
                            {{ lower_first_letter(card.variable_rate_index | join) }}
                            index
                        </dd>
                    {% endif %}
                </dl>
            {% endcall %}
        </div>
    </div>

    <div class="o-card-details-section">
        <h2 class="h3">
            {{ svg_icon("credit-payment-round") }}
            Fees
        </h2>
        {# How top-line fee displays if the card has:
            - Annual fee: "$95 annual fee"
            - Monthly fee: "$8.25 monthly fee"
            - Annual and monthly fee: "$175 annual fee + $12.50 monthly fee"
            - Other fee: "$50 {fee name, period}"
            - Annual and other fee: "$495 annual fee + $50 {fee name, period}"
            - No periodic fee: "$0 annual fee"
            - Fee that varies: "$25 - $55 annual/monthly fee"
        #}
        <div class="m-payment-calculation u-mb15">
            {% if card.annual_fee or not card.periodic_fee_type %}
                <div class="m-payment-calculation__part">
                    <div class="h2 u-mb0 u-mt0">
                        {# A handful of cards have both an annual and monthly
                            fee with one of those fees varying. Because of how
                            the data is (not) structured, we can only tell which
                            fee varies by looking for either "annual" or
                            "monthly" in the text of the fee explanation.
                        #}
                        {% if card.fee_varies %}
                            {% if card.periodic_fee_type | join == "Annual" %}
                                {{ currency(card.periodic_min) ~ ' - '
                                    ~ currency(card.periodic_max) }}
                            {% elif card.fee_explanation.lower().count('annual') %}
                                {{ currency(card.periodic_min) ~ ' - '
                                    ~ currency(card.periodic_max) }}
                            {% else %}
                                {{ currency(card.annual_fee) }}
                            {% endif %}
                        {% else %}
                            {{ currency(card.annual_fee) if card.annual_fee else currency(0) }}
                        {% endif %}
                    </div>
                    <div class="h4 u-mt0 u-mb0">
                        Annual fee
                    </div>
                </div>
            {% endif %}
            {% if card.monthly_fee %}
                {% if card.annual_fee %}
                    <div class="m-payment-calculation__operator h2">+</div>
                {% endif %}
                <div class="m-payment-calculation__part">
                    <div class="h2 u-mb0 u-mt0">
                        {# A handful of cards have both an annual and monthly
                            fee with one of those fees varying. Because of how
                            the data is (not) structured, we can only tell which
                            fee varies by looking for either "annual" or
                            "monthly" in the text of the fee explanation.
                        #}
                        {% if card.fee_varies %}
                            {% if card.periodic_fee_type | join == "Monthly" %}
                                {{ currency(card.periodic_min) ~ ' - '
                                    ~ currency(card.periodic_max) }}
                            {% elif card.fee_explanation.lower().count('monthly') %}
                                {{ currency(card.periodic_min) ~ ' - '
                                    ~ currency(card.periodic_max) }}
                            {% else %}
                                {{ currency(card.monthly_fee) }}
                            {% endif %}
                        {% else %}
                            {{ currency(card.monthly_fee) }}
                        {% endif %}
                    </div>
                    <div class="h4 u-mt0 u-mb0">
                        Monthly fee
                    </div>
                </div>
            {% endif %}
            {% if card.weekly_fee %}
                {% if card.annual_fee or card.monthly_fee %}
                    <div class="m-payment-calculation__operator h2">+</div>
                {% endif %}
                <div class="m-payment-calculation__part">
                    <div class="h2 u-mb0 u-mt0">
                        {{ currency(card.weekly_fee) }}
                    </div>
                    <div class="h4 u-mt0 u-mb0">
                        Weekly fee
                    </div>
                </div>
            {% endif %}
            {% if card.other_periodic_fee_amount %}
                {% if card.annual_fee or card.monthly_fee or card.weekly_fee %}
                    <div class="m-payment-calculation__operator h2">+</div>
                {% endif %}
                <div class="m-payment-calculation__part">
                    <div class="h2 u-mb0 u-mt0">
                        {{ currency(card.other_periodic_fee_amount) }}
                    </div>
                    <div class="h4 u-mt0 u-mb0">
                        {{ card.other_periodic_fee_name | capitalize }},
                        {{ card.other_periodic_fee_frequency | lower }}
                    </div>
                </div>
            {% endif %}
        </div>
        {% if card.fee_explanation is not none %}
            <p>{{ card.fee_explanation }}</p>
        {% endif %}
        <div class="o-additional-details">
            {% set other_fees = [card.other_fee_name, card.other_fee_name_2,
                card.other_fee_name_3, card.other_fee_name_4, card.other_fee_name_5
            ] %}
            {% set other_fees_count = other_fees | length - other_fees.count('') %}
            {% if other_fees_count == 1 %}
                {% set other_fees_label = 'Late, over-limit, and 1 other fee' %}
            {% elif other_fees_count > 1 %}
                {% set other_fees_label = 'Late, over-limit, and ' ~ other_fees_count ~ ' other fees' %}
            {% else %}
                {% set other_fees_label = 'Late and over-limit fees' %}
            {% endif %}
            {% call() expandable({
                'label': other_fees_label,
                'is_bordered': true,
                'is_expanded': false,
                'is_midtone': false
            }) %}
                <dl class="m-list m-list__card-details">
                    <dt>Late fee</dt>
                    <dd>
                        {% if card.late_fees %}
                            {{ currency(card.late_fee_dollars) ~ ' for the first late payment' if
                                card.late_fee_dollars
                            }}
                            {{ 'and' if card.late_fee_dollars
                                and card.late_fee_six_month_billing_cycle
                            }}
                            {{ currency(card.late_fee_six_month_billing_cycle) ~
                                ' for a late payment within six billing cycles of another
                                late payment' if card.late_fee_six_month_billing_cycle
                            }}
                            {# A handful of cards specify neither a first nor repeat late
                                fee and put all late fee info in the late_fee_policy_details
                                field. For cards like that, we'll show the details here and
                                not show the "Late fee policy details" item.
                            #}
                            {# TODO: Refactor to not use the exact string #}
                            {{ card.late_fee_policy_details if card.late_fee_types ==
                                ['3. If you charge late fees that are not fixed dollar amounts, please explain your late fee policy here.']
                            }}
                        {% else %}
                            None
                        {% endif %}
                    </dd>
                    {# See the comment above: we won't show this if we're already showing
                        late fee details in the "Late fee" item, i.e. if the card has *only*
                        policy details chosen in late_fee_types
                    #}
                    {# TODO: Refactor to not use the exact string #}
                    {% if card.late_fee_policy_details
                        and card.late_fee_types !=
                        ['3. If you charge late fees that are not fixed dollar amounts, please explain your late fee policy here.']
                    %}
                        <dt>Late fee policy details</dt>
                        <dd>{{ card.late_fee_policy_details }}</dd>
                    {% endif %}
                    <dt>Over-limit fee</dt>
                    <dd>
                        {% if card.over_limit_fees %}
                            {{ currency(card.over_limit_fee_dollars) if
                                card.over_limit_fee_dollars
                            }}
                            {# A handful of cards specify only over-limit fee details and
                                not a fixed dollar amount. For cards like that, we'll show
                                the details here and not show the "Over-limit fee details."
                            #}
                            {# TODO: Refactor to not use the exact string #}
                            {{ card.overlimit_fee_detail if card.over_limit_fee_types ==
                                ['2. If you charge overlimit fees that are not fixed dollar amounts, please explain what overlimit fees you charge here:']
                            }}
                        {% else %}
                            None
                        {% endif %}
                    </dd>
                    {# See the comment above: we won't show this if we're already showing
                        over-limit fee details in the "Over-limit fee" item, i.e. if the
                        card has *only* details chosen in over_limit_fee_types.
                    #}
                    {# TODO: Refactor to not use the exact string #}
                    {% if card.overlimit_fee_detail
                        and card.over_limit_fee_types !=
                        ['2. If you charge overlimit fees that are not fixed dollar amounts, please explain what overlimit fees you charge here:']
                    %}
                        <dt>Over-limit fee details</dt>
                        <dd>{{ card.overlimit_fee_detail }}</dd>
                    {% endif %}
                    {% if card.other_fees %}
                        {% for fee_name in other_fees %}
                            {% if fee_name %}
                                <dt>{{ fee_name }}</dt>
                                <dd>
                                    {% if loop.first %}
                                        {{ currency(card.other_fee_amount) ~ ' (' ~
                                            card.other_fee_explanation | lower ~ ')'
                                        }}
                                    {% else %}
                                        {{ currency(card['other_fee_amount_' ~ loop.index]) ~ ' (' ~
                                            card['other_fee_explanation_' ~ loop.index] | lower ~
                                            ')'
                                        }}
                                    {% endif %}
                                </dd>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </dl>
            {% endcall %}
        </div>
    </div>

    <div class="o-card-details-section">
        <h2 class="h3">
            {{ svg_icon("gift-round") }}
            Rewards and perks
        </h2>
        {% if card.rewards %}
            <div class="h2 u-mb0 u-mt15">
                {%- set rewards = [] -%}
                {%- for reward in card.rewards -%}
                    {%- do rewards.append(rewards_lookup[reward]) -%}
                {%- endfor -%}
                {{ oxfordize(rewards) | capitalize }}
            </div>
            <div class="h4 u-mt0">
                Rewards
            </div>
        {% else %}
            <p>This card does not offer cash back, travel, or other rewards.</p>
        {% endif %}
        {% if card.other_rewards %}
            <p>Other rewards: {{ card.other_rewards }}</p>
        {% endif %}
        <div class="o-additional-details">
            {% call() expandable({
                'label': 'Card services and features',
                'is_bordered': true,
                'is_expanded': false,
                'is_midtone': false
            }) %}
                <dl class="m-list m-list__card-details">
                    {% if card.services %}
                        <dt>Services</dt>
                        <dd>
                            <ul>
                                {% for service in card.services %}
                                    <li>
                                        {{ service if service != 'Other' else
                                            card.other_services
                                        }}
                                    </li>
                                {% endfor %}
                            </ul>
                        </dd>
                    {% endif %}
                    {% if card.card_features %}
                        <dt>Card features</dt>
                        <dd>
                            <ul>
                                {% for feature in card.card_features %}
                                    <li>
                                        {{ feature if feature != 'Other' else
                                            card.other_card_features
                                        }}
                                    </li>
                                {% endfor %}
                            </ul>
                        </dd>
                    {% endif %}
                </dl>
            {% endcall %}
        </div>
    </div>

    <div class="o-card-details-section">
        <h2 class="h3 u-mb15">
            {{ svg_icon("money-transfer-round") }}
            Transferring a balance from another card or loan
        </h2>
        {# How top-line transfer APR and fees display if the card has:
            - One APR: "1.99% balance transfer APR"
            - Range of APRs: "12.99% - 17.90% balance transfer APR"
            - No transfer fee: "$0 balance transfer fee"
            - Dollar transfer fee: "$5 balance transfer fee"
            - Percentage transfer fee: "3.00% balance transfer fee"
            - Dollar and percentage fee: "$5 or 5.00% balance transfer fee"
            - Custom transfer fee: "Variable transfer fee"
            - Minimum transfer fee: "($5 minimum)" added at the end
        #}
        {% if card.balance_transfer_offered %}
            <div class="m-payment-calculation u-mb15">
                <div class="m-payment-calculation__part">
                    <div class="h2 u-mb0 u-mt15">
                        {% if card.transfer_apr_min is not none
                            and card.transfer_apr_max is not none
                        %}
                            {{ apr_range(card.transfer_apr_min, card.transfer_apr_max) }}
                        {% elif card.transfer_apr_median is not none %}
                            {{ apr(card.transfer_apr_median) }}
                        {% endif %}
                    </div>
                    <div class="h4 u-mt0">
                        {% if card.transfer_apr_min is not none
                            and card.transfer_apr_max is not none
                        %}
                            Balance transfer APR
                        {% elif card.transfer_apr_median is not none %}
                            Median balance transfer APR
                        {% endif %}
                    </div>
                </div>
                <div class="m-payment-calculation__operator h2">+</div>
                <div class="m-payment-calculation__part">
                    <div class="h2 u-mb0 u-mt15">
                        {{ currency(card.balance_transfer_fee_dollars) if
                            card.balance_transfer_fee_dollars is not none
                        }}
                        {# TODO: Is this an "or"? Or can it be an "and"? #}
                        {{ ' or ' if card.balance_transfer_fee_dollars is not none
                            and card.balance_transfer_fee_percentage is not none
                        }}
                        {{ apr(card.balance_transfer_fee_percentage) if
                            card.balance_transfer_fee_percentage is not none
                        }}
                        {{ '(' ~ currency(card.minimum_balance_transfer_fee_amount) ~
                            ' minimum)' if card.minimum_balance_transfer_fee_amount
                            is not none
                        }}
                        {{ 'Variable' if card.balance_transfer_fee_calculation
                            and card.balance_transfer_fee_dollars is none
                            and card.balance_transfer_fee_percentage is none
                        }}
                        {{ currency(0) if not card.balance_transfer_fees }}
                    </div>
                    <div class="h4 u-mt0">
                        Balance transfer fee
                        {{- ', see details' if card.balance_transfer_fee_calculation }}
                    </div>
                </div>
            </div>
            {% if card.balance_transfer_fee_calculation %}
                <p>
                    Balance transfer fee details:
                    {{ card.balance_transfer_fee_calculation }}
                </p>
            {% endif %}
            {% if card.balance_transfer_apr_vary_by_credit_tier %}
                <p>
                    Your balance transfer APR will be based on your credit score.
                    You’ll only know your exact APR if you are approved for the
                    card. Here are average balance transfer APRs for different
                    credit scores for this card:
                </p>
                <table class="o-table o-table--apr">
                    <thead>
                        <tr>
                            <th>Credit score</th>
                            <th>Median balance transfer APR</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transfer_apr in [
                            card.transfer_apr_poor,
                            card.transfer_apr_good,
                            card.transfer_apr_great
                        ] %}
                            <tr>
                                <td>{{ credit_tiers[loop.index][1] }}</td>
                                <td>{{ apr(transfer_apr) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% elif card.transfer_apr_median is not none
                and card.transfer_apr_min != card.transfer_apr_max %}
                <p>
                    You’ll only know your exact balance transfer APR if you are
                    approved for the card. The median balance transfer APR for
                    this card is {{ apr(card.transfer_apr_median) }}.
                </p>
            {% endif %}
            {# TODO: Explain what a grace period is #}
            <p>
                The balance transfer APR is available for
                {{ '%g' | format(card.median_length_of_balance_transfer_apr) }}
                months after getting this card, on average. There is
                {{ 'a' if card.balance_transfer_grace_period else 'no' }}
                balance transfer grace period.
            </p>
        {% else %}
            <p>This card does not offer balance transfers.</p>
        {% endif %}
    </div>

    <div class="o-card-details-section">
        <h2 class="h3 u-mb15">
            {{ svg_icon("quick-cash-round") }}
            Getting a cash advance
        </h2>
        {% if card.cash_advance_apr_offered %}
            <div class="m-payment-calculation u-mb15">
                <div class="m-payment-calculation__part">
                    <div class="h2 u-mb0 u-mt15">
                        {% if card.advance_apr_min is not none
                            and card.advance_apr_max is not none
                        %}
                            {{ apr_range(card.advance_apr_min, card.advance_apr_max) }}
                        {% elif card.advance_apr_median is not none %}
                            {{ apr(card.advance_apr_median) }}
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                    <div class="h4 u-mt0">
                        {% if card.advance_apr_min is not none
                            and card.advance_apr_max is not none
                        %}
                            Cash advance APR
                        {% elif card.advance_apr_median is not none %}
                            Median cash advance APR
                        {% else %}
                            Cash advance APR
                        {% endif %}
                    </div>
                </div>
                <div class="m-payment-calculation__operator h2">+</div>
                <div class="m-payment-calculation__part">
                    <div class="h2 u-mb0 u-mt15">
                        {{ currency(card.cash_advance_fee_dollars) if
                            card.cash_advance_fee_dollars is not none
                        }}
                        {# TODO: Is this an "or"? Or can it be an "and"? #}
                        {{ ' or ' if card.cash_advance_fee_dollars is not none
                            and card.cash_advance_fee_percentage is not none
                        }}
                        {{ apr(card.cash_advance_fee_percentage) if
                            card.cash_advance_fee_percentage is not none
                        }}
                        {{ '(' ~ currency(card.minimum_cash_advance_fee_amount) ~
                            ' minimum)' if card.minimum_cash_advance_fee_amount
                            is not none
                        }}
                        {{ 'Variable' if card.cash_advance_fee_calculation
                            and card.cash_advance_fee_dollars is none
                            and card.cash_advance_fee_percentage is none
                        }}
                        {{ currency(0) if not card.cash_advance_fees }}
                    </div>
                    <div class="h4 u-mt0">
                        Cash advance fee
                        {{- ', see details' if card.cash_advance_fee_calculation }}
                    </div>
                </div>
            </div>
            {% if card.cash_advance_fee_calculation %}
                <p>
                    Cash advance fee details:
                    {{ card.cash_advance_fee_calculation }}
                </p>
            {% endif %}
            {% if card.cash_advance_apr_vary_by_credit_tier %}
                <p>
                    Your cash advance APR will be based on your credit score.
                    You’ll only know your exact APR if you are approved for the
                    card. Here are average cash advance APRs for different
                    credit scores for this card:
                </p>
                <table class="o-table o-table--apr">
                    <thead>
                        <tr>
                            <th>Credit score</th>
                            <th>Median cash advance APR</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for advance_apr in [
                            card.advance_apr_poor,
                            card.advance_apr_good,
                            card.advance_apr_great
                        ] %}
                            <tr>
                                <td>{{ credit_tiers[loop.index][1] }}</td>
                                <td>{{ apr(advance_apr) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% elif card.advance_apr_median is not none
                and card.advance_apr_min != card.advance_apr_max %}
                <p>
                    You’ll only know your exact cash advance APR if you are
                    approved for the card. The median cash advance APR for
                    this card is {{ apr(card.advance_apr_median) }}.
                </p>
            {% endif %}
            {# TODO: Explain this better #}
            <p>
               The cash advance fee is charged
               {{ ' for each cash advance transaction' if
                    card.cash_advance_fee_for_each_transaction else
                    ' once per billing cycle'
                }}.
            </p>
        {% else %}
            <p>This card does not offer cash advanaces.</p>
        {% endif %}
    </div>

</div>

{% endblock content_main %}

{% block content_sidebar %}
    {%- include "tccp/includes/sidebar.html" -%}
{% endblock content_sidebar %}
