{% from 'tccp/includes/data_published.html' import data_published %}
{% from 'tccp/includes/fields.html' import apr, apr_range, currency %}
{% import 'v1/includes/molecules/breadcrumbs.html' as breadcrumbs with context %}
{% import 'v1/includes/molecules/notification.html' as notification %}

{% if count -%}
{{- notification.render(
    'success',
    true,
    count ~ ' result' ~ count | pluralize()
) -}}
{%- else -%}
{{- notification.render(
    'warning',
    true,
    'There are no results for your search.'
) -}}
{%- endif %}

{%- set purchase_apr_adjectives = ["less", "average", "more"] %}

<div class="block__sub">
    <div class="a-label__heading">Key</div>
    <dl>
        {% for adjective in purchase_apr_adjectives %}
        <div class="u-mb0 a-credit-card-apr-rating a-credit-card-apr-rating--{{ adjective }}">
            <dt>
                {%- for i in range(loop.index) -%}
                    {{ svg_icon("dollar-round") }}
                {%- endfor -%}
            </dt>
            <dd>
                Pay {{ adjective ~ (" than average" if adjective != "average") }} interest
            </dd>
        </div>
        {% endfor %}
    </dl>
</div>

{% if stats_all.first_report_date -%}
{{ data_published(stats_all.first_report_date) }}
{%- endif %}

{%- macro card_rating(card) -%}
    {%- set adjective = purchase_apr_adjectives[
        card.purchase_apr_for_tier_rating
    ] -%}

    <span class="a-credit-card-apr-rating--{{ adjective }}">
        {%- for i in range(card.purchase_apr_for_tier_rating + 1) %}
            {{ svg_icon("dollar-round") }}
        {% endfor -%}

        Pay {{ adjective }} interest
    </span>
{%- endmacro -%}

{%- macro card_rewards(card) -%}
    {%- set rewards = [] -%}
    {%- for reward in card.rewards -%}
        {%- do rewards.append(rewards_lookup[reward]) -%}
    {%- endfor -%}
    {{- (rewards | join(', ')) if rewards else 'None' -}}
{%- endmacro -%}

<div class="o-card-group">
    <div class="o-card-group_cards">
        {%- for card in results %}
        <article class="m-card m-card--tabular">
            <a href="{{ card.url }}">
                <div class="m-card__heading-group">
                    <h3 class="m-card__heading">{{ card.institution_name }}</h3>
                    <p class="m-card__subtitle">{{ card.product_name }}</p>
                </div>
                <div class="a-credit-card-apr-rating">{{ card_rating(card) | safe }}</div>
                <dl class="m-data-specs">
                    <div class="m-data-spec m-data-spec--apr">
                        <dt><strong>Purchase APR</strong></dt>
                        <dd>
                            <strong>{{ apr(card.purchase_apr_for_tier) }}</strong>
                        </dd>
                    </div>
                    <div class="m-data-spec m-data-spec--fee">
                        <dt><strong>Account fee</strong></dt>
                        <dd>
                            <strong>{{ currency(card.annual_fee_estimated, default=('See details' if card.annual_fee_estimated is none and card.periodic_fee_type else '$0')) }}</strong>
                        </dd>
                    </div>
                    <div class="m-data-spec m-data-spec--transfer">
                        <dt>Balance transfer APR</dt>
                        <dd>
                            {{ apr(card.transfer_apr_for_tier) if card.transfer_apr_for_tier is not none else apr_range(card.transfer_apr_min, card.transfer_apr_max) }}
                        </dd>
                    </div>
                    <div class="m-data-spec m-data-spec--rewards">
                        <dt>Rewards</dt>
                        <dd>
                            {{ card_rewards(card) | safe }}
                        </dd>
                    </div>
                    {%- if card.requirements_for_opening -%}
                    <div class="m-data-spec m-data-spec--requirements">
                        <dt>Does this card have special requirements?</dt>
                        <dd>
                            See card details page for special requirements
                        </dd>
                    </div>
                    {%- endif -%}
                </dl>
            </a>
        </article>
        {% endfor %}
    </div>
</div>
