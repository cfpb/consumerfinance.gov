{% set is_report = True %}
{% extends 'layout-side-nav.html' %}

{% import './pdf-download.html' as pdf_download with context %}
{% import 'templates/streamfield-sidefoot.html' as streamfield_sidefoot with context %}

{% block css %}
{{ super() }}
<link rel="stylesheet" href="{{ static('apps/research-reports/css/main.css') }}">
{% endblock %}

{% block content_main_modifiers -%}
    {{ super() }} content__flush-bottom research-report
{%- endblock %}

{% set researchers = get_researchers() %}

{% block content_main %}
    <div class="block block__flush-top">
      <div class="eyebrow">{{ page.report_type }}</div>
      <h1>{{ page.header }}</h1>
      <div class="lead-paragraph">{{ page.subheader }}</div>
      <p class="author-names">{% for author in page.report_author_names.all().order_by('pk') %}
        {% if loop.index == 1 %}By {% endif %}
        {% set link_url = researchers.get(author.name) %}
        {%- if link_url -%}<a href={{ link_url }}>{{ author.name }}</a>
        {%- else -%}<span>{{ author.name }}</span>
        {%- endif -%}
        {% if not loop.last and loop.length != 2 %}, {% endif %}
        {% if loop.index == loop.length -1 %}and {% endif %}
        {% endfor %}
      </p>
      {{ pdf_download.render({'pdf_url': page.pdf_location }) }}
    </div>

    {% for section in page.report_sections.all().order_by('pk') -%}
      <h3 class="report-header">
        <a
          style="color:black;"
          id="{{section.html_id}}"
          href="#{{section.html_id}}">
            {{section.header}}
        </a>
      </h3>

      {{ section.body | safe }}

      {% for subsection in section.report_subsections.all().order_by('pk') -%}
        <h4 class="report-header">
          <a
            style="color:black;"
            id="{{subsection.sub_id}}"
            href="#{{subsection.sub_id}}">
              {{subsection.sub_header}}
          </a>
        </h4>

        {{ subsection.sub_body | safe}}
      {%- endfor %}
    {%- endfor %}

    <div class="block block__flush-top">
      {{ page.footnotes }}
    </div>

    {% if page.sidefoot %}
        <aside class="o-prefooter">
            {{ streamfield_sidefoot.render(page.sidefoot, half_width=true) }}
        </aside>
    {% endif %}

{% endblock %}

{% block javascript scoped %}
    {{ super() }}
    <script async>
      if ( document.body.parentElement.className.indexOf( 'no-js' ) === -1 ) {
        !function(){
          {# Include site-wide JavaScript. #}
          var s = [
            '{{ static('apps/research-reports/js/index.js') }}',
          ];
          jsl(s);
        }()
      }
    </script>
{% endblock javascript %}
