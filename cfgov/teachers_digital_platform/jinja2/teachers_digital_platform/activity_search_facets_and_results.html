{% import 'v1/includes/atoms/tag.html' as tag %}
{% import 'v1/includes/molecules/pagination.html' as pagination with context %}
{% from 'teachers_digital_platform/tdp_expandable.html' import expandable with context %}

{% macro build_filter_section(name) %}
    <div class="filter-section">
        {% set label = name | capitalize | replace('_', ' ') %}
        {% set items = facets[name] %}
        {% set expandable_settings = {
            'label': label,
            'is_expanded': true,
            'is_collapsed_for_mobile': true,
            'is_midtone': true
        } %}
        {% call() expandable(expandable_settings) %}
          {{build_form_group(name, items)}}
        {% endcall %}
    </div>
{% endmacro %}

{% macro build_form_group(name, items) %}
    <div class="o-form_group">
        <fieldset class="o-form_fieldset">
            <ul class="m-list m-list__unstyled">
                {% for facet in items %}
                <li>
                    <div class="m-form-field m-form-field__checkbox">
                      <input type="checkbox" class="a-checkbox" aria-label="{{ facet.title }}" id="{{name}}--{{ facet.title | trim | slugify }}" name="{{name}}" value="{{ facet.id }}"{% if facet.selected %} checked="checked"{% endif %}>
                      <label class="a-label" for="{{name}}--{{ facet.title | trim | slugify }}">{{ facet.title }}</label>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </fieldset>
    </div>
{% endmacro %}

{% macro  build_nested_filter_tags(facets, type) %}
    {% for facet in facets %}
        {% if facet.selected %}
            {% set input_id = '#' + type | trim | replace("_","-") + "--" + facet.title | trim | slugify %}
            {{ tag.render({
                'label': facet.title,
                'value': input_id,
                'behavior': 'clear-filter'
            }) }}
        {% endif %}
        {% if facet.children %}
            {{ build_nested_filter_tags(facet.children, type) }}
        {% endif %}
    {% endfor %}
{% endmacro %}

<a class="skip-filters u-visually-hidden{% if not activities %} skip-filters__hidden{% endif %}" href="#tdp-search-results">Skip to search results</a>

{% if page.results.total_results and page.results.total_results > 0 %}
    {# TODO REMOVE THIS #}
          {% set total_activities = 75 %}
          {% set fake_results = 75 if page.results.total_results == 274 else page.results.total_results %}
          {% set fake_results = fake_results if fake_results < 76 else (fake_results / 4) | round |int %}
        <div class="results_count block__padded-bottom u-hide-on-med u-hide-on-lg u-hide-on-xl" data-results-count="{{ fake_results }}">
        <h3>
            {% if total_activities > fake_results %}
                Showing {{ fake_results }}
                match{% if fake_results > 1 %}es{% endif %}
                out of
            {% endif %}
            {{ total_activities }} activities
        </h3>
    </div>
{% else %}
    <div class="results_count results_count__empty u-hide-on-med u-hide-on-lg u-hide-on-xl" data-results-count="0">
        <h3>No results match your search.</h3>
        <p class="u-mb15">Try a <a href="/consumer-tools/educator-tools/youth-financial-education/teach/activities/">new search</a> with different terms or filters.</p>
    </div>
{% endif %}

<aside class="content_sidebar content__flush-top-on-small content__flush-sides-on-small filters{% if not activities %} filters__hidden{% endif %}">
    <h3 class="h2">Filter results by</h3>
    <form action="." method="get" data-js-hook="behavior_change-filter">
        <input type="hidden" name="q" value="{% if search_query: %}{{ search_query }}{% endif %}">
        <input type="hidden" name="page" inputmode="numeric" value="1">

        {% if facets.grade_level %}{{build_filter_section('grade_level')}}{% endif %}
        {% if facets.activity_duration %}{{build_filter_section('activity_duration')}}{% endif %}
        {% if facets.topic %}
          <div class="filter-section">
            {% set items = facets.topic %}
            {% set expandable_settings = {
                'label': 'Topic',
                'is_expanded': true,
                'is_collapsed_for_mobile': true,
                'is_midtone': true
            } %}
            {% call() expandable(expandable_settings) %}
              {% for topic in items %}
              <h5>{{topic.title}}</h5>
              {{build_form_group('topic', topic.children)}}
              <br/>
              {% endfor %}
            {% endcall %}
          </div>
        {% endif %}

        <input type="hidden" value="{% if page.results.search_query: %}{{ page.results.search_query }}{% endif %}" name="q">
        <button class="a-btn u-mb15 u-hide-on-js">Apply filters</button>
    </form>

</aside>
<section id="tdp-search-results" class="content_main content__flush-all-on-small content__flush-bottom results{% if not activities %} results__full{% endif %}" tabindex="-1">
    <a class="u-visually-hidden" id="content_main"></a>
    <div class="results_header">
        {% if page.results.total_results and page.results.total_results > 0 %}
          {% set total_activities = 75 %}
          {% set fake_results = 75 if page.results.total_results == 274 else page.results.total_results %}
          {% set fake_results = fake_results if fake_results < 76 else (fake_results / 4) | round |int %}
            <div class="results_count u-hide-on-sm u-hide-on-xs" data-results-count="{{ fake_results }}">
                <h3>
                    {% if total_activities > fake_results %}
                        Showing {{ fake_results }}
                        match{% if fake_results > 1 %}es{% endif %}
                        out of
                    {% endif %}
                    {{ total_activities }} activities
                </h3>
            </div>
        {% else %}
            <div class="results_count results_count__empty u-hide-on-sm u-hide-on-xs" data-results-count="0">
                <h3>No results match your search.</h3>
                <p class="u-mb15">Try a <a href="/consumer-tools/educator-tools/youth-financial-education/teach/activities/">new search</a> with different terms or filters.</p>
            </div>
        {% endif %}
        {% if show_filters %}
            <div class="results_filters">
                <span class="results_filters-label">
                    Filters applied
                </span>
                <div class="results_filters-tags">
                    {% for facet_name, facet_items in facets | items %}
                        {% if facet_name == 'topic'%}
                          {{ build_nested_filter_tags(facet_items, facet_name) }}
                        {% else %}
                          {% for facet in facet_items %}
                            {% if facet.selected %}
                                {% set input_id = '#' + facet_name | trim + "--" + facet.title | trim | slugify %}
                                {{ tag.render({
                                    'label': facet.title,
                                    'value': input_id,
                                    'behavior': 'clear-filter'
                                }) }}
                                {% endif %}
                        {% endfor %}
                            {% endif %}
                    {% endfor %}
                    <button class="a-btn a-btn__link a-btn__warning a-micro-copy results_filters-clear u-mb10"
                            data-js-hook="behavior_clear-all">
                        Clear all filters
                    </button>
                </div>
            </div>
        {% endif %}
    </div>
    {% if activities %}
        <div class="results_list">
            <ul class="m-list__unstyled">
                {% for result in activities %}
                    {% if result %}
                    <li class="u-mb30">{% include "activity_search_result.html" %}</li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
        <div class="results_footer">
            {{ pagination.render( paginator.num_pages, current_page, 'tdp-search-facets-and-results', '', 'Previous', 'Next' ) }}
            <div class="o-well">
                Activities align with the My Money Five principles introduced by the statutorily created federal Financial Literacy and Education Commission.
            </div>
        </div>
    {% endif %}
</section>
