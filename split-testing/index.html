<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Split Testing - consumerfinance.gov</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../css/overrides.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Split Testing";
    var mkdocs_page_input_path = "split-testing.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> consumerfinance.gov</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Introduction</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../installation/">Installation</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Running this Project</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../running-virtualenv/">Running in a Virtual Environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../running-docker/">Running in Docker</a>
                </li>
                <li class="">
                    
    <a class="" href="../debugging-monitoring/">Debugging and Monitoring</a>
                </li>
                <li class="">
                    
    <a class="" href="../deployment/">Artifacts and Deployment</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Pages and Components</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../atomic-structure/">Atomic Structure and Design</a>
                </li>
                <li class="">
                    
    <a class="" href="../editing-components/">Creating and Editing Components</a>
                </li>
                <li class="">
                    
    <a class="" href="../debugging-templates/">Debugging Templates</a>
                </li>
                <li class="">
                    
    <a class="" href="../migrations/">Django and Wagtail Migrations</a>
                </li>
                <li class="">
                    
    <a class="" href="../forms-in-wagtail/">Forms in Wagtail Page Context</a>
                </li>
                <li class="">
                    
    <a class="" href="../wagtail-pages/">Wagtail Pages</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Supporting Features</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../caching/">Caching</a>
                </li>
                <li class="">
                    
    <a class="" href="../feature-flags/">Feature Flags</a>
                </li>
                <li class="">
                    
    <a class="" href="../search/">Search</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Split Testing</a>
    <ul class="subnav">
            
    
        <ul>
        
            <li><a class="toctree-l4" href="#so-youve-been-asked-to-set-up-a-split-testing-experiment">So you've been asked to set up a split testing experiment</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../translation/">Translation</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Testing</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../javascript-unit-tests/">JavaScript Unit Testing</a>
                </li>
                <li class="">
                    
    <a class="" href="../python-unit-tests/">Python Unit Testing</a>
                </li>
                <li class="">
                    
    <a class="" href="../functional-testing/">Functional Testing</a>
                </li>
                <li class="">
                    
    <a class="" href="../profiling-django/">Profiling Django</a>
                </li>
                <li class="">
                    
    <a class="" href="../other-front-end-testing/">Other Front-end Testing</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Contributing</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../branching-merging/">Branching and Merging</a>
                </li>
                <li class="">
                    
    <a class="" href="../contributing-docs/">Contributing to the Docs</a>
                </li>
                <li class="">
                    
    <a class="" href="../related-projects/">Related Projects</a>
                </li>
                <li class="">
                    
    <a class="" href="../development-tips/">Development Tips</a>
                </li>
                <li class="">
                    
    <a class="" href="../github-actions/">How We Use GitHub Actions</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">APIs and Data</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../ask-cfpb/">Ask CFPB</a>
                </li>
                <li class="">
                    
    <a class="" href="../consumer-complaint-database/">Consumer Complaints</a>
                </li>
                <li class="">
                    
    <a class="" href="../housing-counselor-tool/">Find a Housing Counselor Tool</a>
                </li>
                <li class="">
                    
    <a class="" href="../website-feedback/">Website Feedback</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">consumerfinance.gov</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Supporting Features &raquo;</li>
        
      
    
    <li>Split Testing</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/cfpb/consumerfinance.gov/edit/master/docs/split-testing.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="setting-up-a-split-testing-experiment">Setting up a split testing experiment<a class="headerlink" href="#setting-up-a-split-testing-experiment" title="Permanent link">¶</a></h1>
<p>One thing we like to do from time to time is test changes
on specific groups of pages and see how they perform.
We call this "split testing".
In contrast to traditional A/B testing,
where the change being tested is shown to a portion of the <em>audience</em>,
in the case of split testing,
the change is shown to everyone, but only on a subset of similar pages
(e.g., a group of related Ask CFPB answers).
We call this a subset of pages a "cluster".</p>
<h2 id="so-youve-been-asked-to-set-up-a-split-testing-experiment">So you've been asked to set up a split testing experiment<a class="headerlink" href="#so-youve-been-asked-to-set-up-a-split-testing-experiment" title="Permanent link">¶</a></h2>
<p>Good news! The infrastructure has been put in place for you to do it easily.
It's set up so that the code being tested is isolated by a feature flag.
If you're not familiar with how our flags are set up,
<a href="https://cfpb.github.io/django-flags/#concepts">read the concepts overview in the django-flags concepts</a>.</p>
<h3 id="the-flag-condition">The flag condition<a class="headerlink" href="#the-flag-condition" title="Permanent link">¶</a></h3>
<p>In order to check whether or not a page is part of a split testing cluster,
we registered a new flag condition in <code>cfgov/core/feature_flags.py</code>.</p>
<pre class="highlight"><code class="language-python">@conditions.register('in split testing cluster')
def in_split_testing_cluster(cluster_group, page, clusters=CLUSTERS, **kwargs):
    cluster_group = clusters[cluster_group]
    lookup_value = getattr(page, 'split_test_id', page.id)
    return lookup_value in chain(*cluster_group.values())</code></pre>

<p>This condition takes the following arguments:
- <code>cluster_group</code>: A string that identifies which group of clusters we want
  to check
- <code>page</code>: An instance of a Wagtail page that we want to look for in the
  cluster group
- <code>clusters</code>: A dictionary containing one or more named <code>cluster_group</code>s –
  by default, this points to a dictionary defined in our main cluster
  definition file (see <a href="#defining-clusters">"Defining clusters"</a> below)</p>
<p>If the <code>page</code>'s <code>id</code> property is found in the <code>cluster_group</code>,
the condition returns <code>True</code>.
If the page has a <code>split_test_id</code> property defined, it will check that
instead of <code>page.id</code>. (More on that later.)</p>
<p>You do not need to modify anything in this file to set up a new experiment.</p>
<h3 id="defining-clusters">Defining clusters<a class="headerlink" href="#defining-clusters" title="Permanent link">¶</a></h3>
<p>To run a split test we first have to know what pages we're testing.
Split testing clusters are typically defined in our main cluster definition
file at <code>cfgov/core/split_testing_clusters.py</code>.</p>
<p>Create a new dictionary with a meaningful name
and add the page IDs for the pages in your cluster(s) to it.
For example:</p>
<pre class="highlight"><code class="language-python">ASK_CFPB_H1 = {
    18: [
        103, 160, 187, 337, 731, 767, 951, 1157, 1161, 1403, 1405, 1439, 1447,
        1567, 1695,
    ],
    34: [
        104, 105, 130, 205, 747, 841, 1423, 1791,
    ],
    38: [
        143, 184, 329, 331, 1165, 1637, 1787, 1789, 1797, 1921, 1923,
    ],
    49: [
        136, 161, 163, 164, 172, 176, 179, 180, 181, 188, 192, 336, 817, 1699,
        1983, 1989, 1995, 1997, 2001,
    ],
    93: [
        146, 226, 237, 318, 338, 545, 633, 811, 1215, 1463, 1507,
    ],
}</code></pre>

<p>In the above example, there are five separate clusters,
<em>all</em> of which will be part of the experiment.
The number being used for the keys doesn't matter to Python,
but it may be useful for internal tracking purposes.</p>
<p>As noted earlier, normally the page IDs inside the lists correspond to
Wagtail's page ID (most easily findable in the edit URL for a page),
but in this particular example, they are actually <strong>Ask CFPB answer IDs</strong>.
For Ask CFPB answer pages, we use the answer ID,
because that ID is frequently used in internal communications
for shorthand references to Ask answers.
All other page types use their Wagtail page ID value.</p>
<p>If you have cause to use something else for the lookup values,
you can define the <code>split_test_id</code> property in a page class.
For example:</p>
<pre class="highlight"><code class="language-python"># cfgov/ask_cfpb/models/pages.py

class AnswerPage(CFGOVPage):
…
    # Overrides the default of page.id for comparing against split testing
    # clusters. See: core.feature_flags.in_split_testing_cluster
    @property
    def split_test_id(self):
        return self.answer_base.id
…</code></pre>

<p>If you do this, remember to add a simple test:</p>
<pre class="highlight"><code class="language-python"># cfgov/ask_cfpb/tests/models/test_pages.py

def test_answer_split_testing_id(self):
    &quot;&quot;&quot;Confirm AnswerPage's split_testing_id is set to its answer_base.id,
    which is checked by the core.feature_flags.in_split_testing_cluster
    flag condition when doing split testing on Ask CFPB answer pages.&quot;&quot;&quot;
    answer = self.answer1234
    page = answer.english_page
    self.assertEqual(page.split_test_id, answer.id)</code></pre>

<p>You will also need to add a reference to your new dictionary
to the <code>CLUSTERS</code> dictionary at the bottom of the file:</p>
<pre class="highlight"><code class="language-python">CLUSTERS = {
    'ASK_CFPB_H1': ASK_CFPB_H1,
}</code></pre>

<h3 id="creating-and-using-the-flag">Creating and using the flag<a class="headerlink" href="#creating-and-using-the-flag" title="Permanent link">¶</a></h3>
<p><a href="#the-flag-condition">The new "in split testing cluster" condition</a>
described earlier can be added to flags and used like any other feature flag.
For the example we started above, we first create the flag in our settings,
giving it the default condition with a parameter corresponding to the
cluster group name we created above:</p>
<pre class="highlight"><code class="language-python"># cfgov/settings/base.py

…

# Feature flags
# All feature flags must be listed here with a dict of any hard-coded
# conditions or an empty dict. If the conditions dict is empty the flag will
# only be enabled if database conditions are added.
FLAGS = {
    …
    # SPLIT TESTING FLAGS

    # Ask CFPB page titles as H1s instead of H2s
    'ASK_CFPB_H1': {
        'in split testing cluster': 'ASK_CFPB_H1'
    },
    …
}

…</code></pre>

<p>And then in our template we check the flag, passing in the current <code>page</code>,
and if the page's answer ID is found in a cluster, <code>flag_enabled()</code> is <code>True</code>,
and we see the <code>&lt;h1&gt;</code> instead of the <code>&lt;h2&gt;</code>.</p>
<pre class="highlight"><code class="language-html">&lt;!-- cfgov/jinja2/v1/ask-cfpb/answer-page.html --&gt;

…

{% if flag_enabled('ASK_CFPB_H1', page=page) %}
    &lt;h1&gt;{{ page.question | striptags }}&lt;/h1&gt;
{% else %}
    &lt;h2&gt;{{ page.question | striptags }}&lt;/h2&gt;
{% endif %}

…</code></pre>

<p>Setting the flag up with the default condition of <code>in_split_testing_cluster</code>
means that as soon as the code is deployed,
the flag is acting on pages in the cluster.</p>
<p>One the results of the test are known, you can set a new boolean flag condition
in Wagtail to have the flag always be <code>True</code>, if the test was successful,
or always be <code>False</code>, if the test was not successful.
This will make (or not make) the change on all pages touched by that flag
until you take the time to remove the flag entirely.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../translation/" class="btn btn-neutral float-right" title="Translation">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../search/" class="btn btn-neutral" title="Search"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/cfpb/consumerfinance.gov/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../search/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../translation/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
