<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Python Unit Testing - consumerfinance.gov</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../css/overrides.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Python Unit Testing";
        var mkdocs_page_input_path = "python-unit-tests.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> consumerfinance.gov
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation/">Setup</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Running this Project</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../running-virtualenv/">Running in a Virtual Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../running-docker/">Running in Docker</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../debugging-monitoring/">Debugging and Monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../deployment/">Artifacts and Deployment</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Pages and Components</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../atomic-structure/">Atomic Structure and Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../editing-components/">Creating and Editing Components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../debugging-templates/">Debugging Templates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../migrations/">Django and Wagtail Migrations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../forms-in-wagtail/">Forms in Wagtail Page Context</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wagtail-pages/">Wagtail Pages</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Supporting Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../caching/">Caching</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../feature-flags/">Feature Flags</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../filterable-lists/">Filterable Lists</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../page-search/">Page Search</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../site-search/">Site Search</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../translation/">Translation</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Testing</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../javascript-unit-tests/">JavaScript Unit Testing</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Python Unit Testing</a>
    <ul class="current">
    
        <ul>
        
            <li><a class="toctree-l4" href="#writing-tests">Writing tests</a></li>
        
            <li><a class="toctree-l4" href="#prerequisites">Prerequisites</a></li>
        
            <li><a class="toctree-l4" href="#running-tests">Running tests</a></li>
        
            <li><a class="toctree-l4" href="#test-output">Test output</a></li>
        
            <li><a class="toctree-l4" href="#govdelivery">GovDelivery</a></li>
        
        </ul>
    

    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../functional-testing/">Functional Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../profiling-django/">Profiling Django</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../other-front-end-testing/">Other Front-end Testing</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Contributing</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../branching-merging/">Branching and Merging</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../contributing-docs/">Contributing to the Docs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../related-projects/">Related Projects</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development-tips/">Development Tips</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../github-actions/">How We Use GitHub Actions</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">APIs and Data</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../ask-cfpb/">Ask CFPB</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../consumer-complaint-database/">Consumer Complaints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../housing-counselor-tool/">Find a Housing Counselor Tool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../website-feedback/">Website Feedback</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">consumerfinance.gov</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Testing &raquo;</li><li>Python Unit Testing</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/cfpb/consumerfinance.gov/edit/master/docs/python-unit-tests.md"
          class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="python-testing">Python testing<a class="headerlink" href="#python-testing" title="Permanent link">¶</a></h1>
<h2 id="writing-tests">Writing tests<a class="headerlink" href="#writing-tests" title="Permanent link">¶</a></h2>
<p>We have multiple resources for writing new unit tests for Django, Wagtail, and Python code:</p>
<ul>
<li><a href="https://github.com/cfpb/development/blob/main/guides/unittesting-django-wagtail.md">CFPB Django and Wagtail unit testing documentation</a></li>
<li><a href="https://docs.djangoproject.com/en/1.11/topics/testing/overview/">The Django testing documentation</a></li>
<li><a href="http://docs.wagtail.io/en/stable/advanced_topics/testing.html">The Wagtail testing documentation</a></li>
<li><a href="https://realpython.com/testing-in-django-part-1-best-practices-and-examples/">Real Python's "Testing in Django"</a></li>
</ul>
<h3 id="testing-elasticsearch">Testing Elasticsearch<a class="headerlink" href="#testing-elasticsearch" title="Permanent link">¶</a></h3>
<p>When writing tests that rely on a running Elasticsearch service, consider using the
<a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/search/elasticsearch_helpers.py"><code>search.elasticsearch_helpers.ElasticsearchTestsMixin</code></a>
mixin:</p>
<pre class="highlight"><code class="language-py">from django.test import TestCase

from search.elasticsearch_helpers import ElasticsearchTestsMixin


class MyTests(ElasticsearchTestsMixin, TestCase):
    def test_something(self):
        self.rebuild_elasticsearch_index()

        # test something that relies on the Elasticsearch index</code></pre>
<p>Refer to the mixin's
<a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/search/elasticsearch_helpers.py">source code</a>
for additional details on its functionality.</p>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">¶</a></h2>
<p>If you have set up
<a href="/installation/#install-system-level-requirements">a standalone installation of consumerfinance.gov</a>,
you'll need to
<a href="/running-virtualenv/#3-launch-site">activate your virtual environment</a>
before running the tests:</p>
<pre class="highlight"><code class="language-sh">workon consumerfinance.gov</code></pre>
<p>If you have not set up the standalone installation of consumerfinance.gov,
you can still run the tests if you install Tox in your
<a href="https://github.com/cfpb/development/blob/main/guides/installing-python.md">local installation of Python</a>:</p>
<pre class="highlight"><code>pip install tox</code></pre>
<p>If you have set up
<a href="/installation/#docker-based-installation">a Docker-based installation of consumerfinance.gov</a>,
you can run the tests there by
<a href="http://localhost:8888/running-docker/#access-a-containers-shell">accessing the Python container's shell</a>:</p>
<pre class="highlight"><code class="language-sh">docker-compose exec python sh</code></pre>
<h2 id="running-tests">Running tests<a class="headerlink" href="#running-tests" title="Permanent link">¶</a></h2>
<p>Our test suite can either be run in a local virtualenv or in Docker.
Please note, the tests run quite slow in Docker.</p>
<p>To run the the full suite of Python tests using Tox,
make sure you are in the consumerfinance.gov root and then run:</p>
<pre class="highlight"><code class="language-sh">tox</code></pre>
<p>Tox runs different isolated Python environments with different versions of dependencies.
We use it to format and lint our Python files, check out import sorting, and run unit tests
in Python 3.8.
You can select specific environments using <code>-e</code>.</p>
<p>Running <code>tox</code> by itself is the same as running:</p>
<pre class="highlight"><code class="language-sh">tox -e lint -e unittest</code></pre>
<p>These default environments are:</p>
<ul>
<li><code>lint</code>, which runs our <a href="#linting">linters</a>. We require this
  environment to pass in CI.</li>
<li><code>validate-migrations</code>, which checks for any missing Django migrations.
  We require this environment to pass in CI.</li>
<li><code>unittest</code>, which runs unit tests against the current production
  versions of Python, Django, and Wagtail. We require this environment to
  pass in CI.</li>
</ul>
<p>Tests will run against the default Django database.</p>
<p>If you would like to run only a specific test, or the tests for a specific app,
you can provide a dotted path to the test as the final argument to any of the above calls to <code>tox</code>:</p>
<pre class="highlight"><code class="language-sh">tox -e unittest regulations3k.tests.test_regdown</code></pre>
<p>If you would like to skip running Django migrations when testing, set the
<code>SKIP_DJANGO_MIGRATIONS</code> environment variable to any value before running <code>tox</code>.</p>
<h3 id="formatting">Formatting<a class="headerlink" href="#formatting" title="Permanent link">¶</a></h3>
<p>We use <code>black</code> to autoformat our Python code. <code>black</code> is invoked by Tox using
the <code>lint</code> environment (this will also run <code>flake8</code> and <code>isort</code>):</p>
<pre class="highlight"><code class="language-sh">tox -e lint</code></pre>
<p><strong>It is highly recommended to only invoke black via tox</strong></p>
<h3 id="linting">Linting<a class="headerlink" href="#linting" title="Permanent link">¶</a></h3>
<p>We use the <code>flake8</code> and <code>isort</code> tools to ensure compliance with
<a href="https://www.python.org/dev/peps/pep-0008/">PEP8 style guide</a>,
<a href="https://docs.djangoproject.com/en/dev/internals/contributing/writing-code/coding-style/">Django coding style guidelines</a>,
and the
<a href="https://github.com/cfpb/development/blob/main/standards/python.md#linting">CFPB Python style guide</a>.</p>
<p>We also use <a href="https://bandit.readthedocs.io/">Bandit</a> to find any common
security issues in our Python code.</p>
<p><code>flake8</code>, <code>isort</code>, and <code>bandit</code> can all be run using the Tox <code>lint</code> environment
(this will also run <code>black</code>):</p>
<pre class="highlight"><code class="language-sh">tox -e lint</code></pre>
<p>This will run <code>isort</code> in check-only mode and it will print diffs for imports
that need to be fixed. To automatically fix import sort issues, run:</p>
<pre class="highlight"><code class="language-sh">isort --recursive cfgov/</code></pre>
<p>From the root of <code>consumerfinance.gov</code>.</p>
<h3 id="coverage">Coverage<a class="headerlink" href="#coverage" title="Permanent link">¶</a></h3>
<p>To see Python code coverage information immediately following a test run,
you can add the <code>coverage</code> env to the list of envs for tox to run:</p>
<pre class="highlight"><code class="language-sh">tox -e lint -e unittest -e coverage</code></pre>
<p>You can also run coverage directly to see coverage information from a previous test run:</p>
<pre class="highlight"><code class="language-sh">coverage report -m</code></pre>
<p>To see coverage for a limited number of files,
use the <code>--include</code> argument to <code>coverage</code> and provide a path to the files you wish to see:</p>
<pre class="highlight"><code class="language-sh">coverage report -m --include=./cfgov/regulations3k/*</code></pre>
<h2 id="test-output">Test output<a class="headerlink" href="#test-output" title="Permanent link">¶</a></h2>
<p>Python tests should avoid writing to stdout as part of their normal execution.
To enforce this convention, the tests can be run using a custom Django test
runner that fails if anything is written to stdout. This test runner is at
<code>cfgov.test.StdoutCapturingTestRunner</code> and can be enabled with the <code>TEST_RUNNER</code>
environment variable:</p>
<pre class="highlight"><code class="language-sh">TEST_RUNNER=core.testutils.runners.StdoutCapturingTestRunner tox -e unittest</code></pre>
<p>This test runner is enabled when tests are run automatically on
<a href="../github-actions/">GitHub Actions</a>,
but is not used by default when running tests locally.</p>
<h2 id="govdelivery">GovDelivery<a class="headerlink" href="#govdelivery" title="Permanent link">¶</a></h2>
<p>If you write Python code that interacts with the GovDelivery subscription API, you can use the functionality provided in <code>core.govdelivery.MockGovDelivery</code> as a mock interface to avoid the use of <code>patch</code> in unit tests.</p>
<p>This object behaves similarly to the real <code>govdelivery.api.GovDelivery</code> class in that it handles all requests and returns a valid (200) <code>requests.Response</code> instance.</p>
<p>Conveniently for unit testing, all calls are stored in a class-level list that can be retrieved at <code>MockGovDelivery.calls</code>. This allows for testing of code that interacts with GovDelivery by checking the contents of this list to ensure that the right methods were called.</p>
<p>This pattern is modeled after Django's <a href="https://docs.djangoproject.com/en/2.0/topics/testing/tools/#email-services"><code>django.core.mail.outbox</code></a> which provides similar functionality for testing sending of emails.</p>
<p>The related classes <code>ExceptionMockGovDelivery</code> and <code>ServerErrorMockGovDelivery</code> can similarly be used in unit tests to test for cases where a call to the GovDelivery API raises an exception and returns an HTTP status code of 500, respectively.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../javascript-unit-tests/" class="btn btn-neutral float-left" title="JavaScript Unit Testing"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../functional-testing/" class="btn btn-neutral float-right" title="Functional Testing">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/cfpb/consumerfinance.gov" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../javascript-unit-tests/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../functional-testing/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
