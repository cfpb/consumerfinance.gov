apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "cfgov.fullname" . }}-smoke-test-job"
  labels: {{- include "cfgov.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  restartPolicy: Never
  containers:
    - name: "{{ include "cfgov.fullname" . }}-smoke-test-job"
      image:  "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
      imagePullPolicy: {{ .Values.image.pullPolicy }}
      command:
        - "bash"
      args:
        - '-c'
        - "python cfgov/scripts/http_smoke_test.py -v"
      volumeMounts:
        {{- range $.Values.volumes }}
        - mountPath: {{ .mountPath }}
          name: {{ .name }}
        {{- end }}

  volumes:
  {{- range $.Values.volumes }}
  - name: {{ .name }}
    {{- toYaml .volume | nindent 14 }}
  {{- end }}
