<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Filterable Lists - consumerfinance.gov</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  <link href="../css/overrides.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Filterable Lists";
    var mkdocs_page_input_path = "filterable-lists.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> consumerfinance.gov</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../installation/">Setup</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Running this Project</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../running-virtualenv/">Running in a Virtual Environment</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../running-docker/">Running in Docker</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../debugging-monitoring/">Debugging and Monitoring</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../deployment/">Artifacts and Deployment</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Pages and Components</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../atomic-structure/">Atomic Structure and Design</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../editing-components/">Creating and Editing Components</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../debugging-templates/">Debugging Templates</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../migrations/">Django and Wagtail Migrations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../forms-in-wagtail/">Forms in Wagtail Page Context</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../wagtail-pages/">Wagtail Pages</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Supporting Features</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../caching/">Caching</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../feature-flags/">Feature Flags</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Filterable Lists</a>
    <ul class="current">
    
        <ul>
        
            <li><a class="toctree-l4" href="#how-it-works">How It Works</a></li>
        
        </ul>
    

    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../page-search/">Page Search</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../site-search/">Site Search</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../translation/">Translation</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Testing</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../javascript-unit-tests/">JavaScript Unit Testing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../python-unit-tests/">Python Unit Testing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../functional-testing/">Functional Testing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../profiling-django/">Profiling Django</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../other-front-end-testing/">Other Front-end Testing</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Contributing</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../branching-merging/">Branching and Merging</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../contributing-docs/">Contributing to the Docs</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../related-projects/">Related Projects</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../development-tips/">Development Tips</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../github-actions/">How We Use GitHub Actions</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">APIs and Data</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../ask-cfpb/">Ask CFPB</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../consumer-complaint-database/">Consumer Complaints</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../housing-counselor-tool/">Find a Housing Counselor Tool</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../website-feedback/">Website Feedback</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">consumerfinance.gov</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Supporting Features &raquo;</li>
        
      
    
    <li>Filterable Lists</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/cfpb/consumerfinance.gov/edit/master/docs/filterable-lists.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="filterable-lists">Filterable Lists<a class="headerlink" href="#filterable-lists" title="Permanent link">Â¶</a></h1>
<p>In order to provide a broad, configurable search and filtering interface across areas of our site, we have implemented a custom StreamField block, <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/v1/atomic_elements/organisms.py#L802">FilterableList</a>, that allows a user to specify what filters are available, how to order results, and which pages should be included in the search.</p>
<ul>
<li><a href="#how-it-works">How It Works</a><ul>
<li><a href="#filterablelistmixin">FilterableListMixin</a></li>
<li><a href="#categoryfilterablemixin">CategoryFilterableMixin</a></li>
</ul>
</li>
<li><a href="#forms">Forms</a><ul>
<li><a href="#filterablelistform">FilterableListForm</a></li>
<li><a href="#enforcementactionsfilterform">EnforcementActionsFilterForm</a></li>
<li><a href="#eventarchivefilterform">EventArchiveFilterForm</a></li>
</ul>
</li>
<li><a href="#documents">Documents</a></li>
<li><a href="#search">Search</a><ul>
<li><a href="#filterablepagesdocumentsearch">FilterablePagesDocumentSearch</a></li>
<li><a href="#eventfilterablepagesdocumentsearch">EventFilterablePagesDocumentSearch</a></li>
<li><a href="#enforcementactionfilterablepagesdocumentsearch">EnforcementActionFilterablePagesDocumentSearch</a></li>
</ul>
</li>
</ul>
<h2 id="how-it-works">How It Works<a class="headerlink" href="#how-it-works" title="Permanent link">Â¶</a></h2>
<p>The journey on how a page gets a filterable form is not necessarily a straight or simple path, but it is something that is important to know. To start, the page must support the <code>FilterableList</code> block within a StreamField as we mentioned earlier, but from there we start to see some divergence. In order to utilize the <code>FilterableList</code> the page must support one of the following two classes: <code>FilterableListMixin</code> or <code>CategoryFilterableMixin</code>.</p>
<h3 id="filterablelistmixin">FilterableListMixin<a class="headerlink" href="#filterablelistmixin" title="Permanent link">Â¶</a></h3>
<p>The more common mixin that pages will extend is the <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/v1/models/filterable_list_mixins.py#L15">FilterableListMixin</a>. This class defines several important methods, such as <code>get_form_class</code>, which defines the form to use. We also have some methods that retrieve relevant information for the form to use, such as <code>get_filterable_list_wagtail_block</code>, <code>get_filterable_root</code>, and <code>get_filterable_queryset</code>. The bulk of the work is done in the <code>get_context</code> method, which is responsible for getting and populating the form, processing the form, and returning the results to the user.</p>
<h3 id="categoryfilterablemixin">CategoryFilterableMixin<a class="headerlink" href="#categoryfilterablemixin" title="Permanent link">Â¶</a></h3>
<p>The <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/v1/models/filterable_list_mixins.py#L199">CategoryFilterableMixin</a> is an extension of the base <code>FilterableListMixin</code> that exposes some new functionality. It modifies how <code>get_filterable_queryset</code> operates in that it gets an initial list of pages but limits them to only ones that are assigned a category within a set of initial categories, which is defined as the variable <code>filterable_categories</code> on a given page model. We can see this in action with both Newsroom (<code>NewsroomLandingPage</code>) and Recent Updates (<code>ActivityLogPage</code>) pages.</p>
<h3 id="forms">Forms<a class="headerlink" href="#forms" title="Permanent link">Â¶</a></h3>
<p>As of our initial release of Elasticsearch-backed filterable lists in March 2021, our filterable forms can be broken into three specific forms: <code>FilterableListForm</code>, <code>EnforcementActionsFilterableListForm</code>, and <code>EventArchiveFilterForm</code>. The majority of our filterable lists rely on <code>FilterableListForm</code> and the other two are each leveraged by a single page.</p>
<h4 id="filterablelistform">FilterableListForm<a class="headerlink" href="#filterablelistform" title="Permanent link">Â¶</a></h4>
<p>This is the base form that the vast majority of cf.gov uses for filterable lists. It defines the core fields that are visible on the form as well as functions to assist in setting initial data and sanitizing form input. The important information regarding <code>FilterableListForm</code> is that it defines the function <code>get_page_set</code>, which is responsible for invoking a search query. The logic regarding how to pass categories into the search object is due to the previously mentioned <code>CategoryFilterableMixin</code>, which modifies the initial search parameters to enforce a category search if and only if the <code>filterable_categories</code> list is passed into the form when initialized.</p>
<h4 id="enforcementactionsfilterform">EnforcementActionsFilterForm<a class="headerlink" href="#enforcementactionsfilterform" title="Permanent link">Â¶</a></h4>
<p>The <code>EnforcementActionsFilterForm</code> is an extension of <code>FilterableListForm</code>, adding on two fields specific to Enforcement Actions, and using a refined search class to provide search functionality against the new fields and a proper ordering by initial filing date.</p>
<h4 id="eventarchivefilterform">EventArchiveFilterForm<a class="headerlink" href="#eventarchivefilterform" title="Permanent link">Â¶</a></h4>
<p>The <code>EventArchiveFilterForm</code> is another extension of <code>FilterableListForm</code>, the only real modification being the invocation of an event specific search class that allows us to provide filtering based on event dates rather than page publication dates.</p>
<h3 id="documents">Documents<a class="headerlink" href="#documents" title="Permanent link">Â¶</a></h3>
<p>There is currently only one type of document defined, <code>FilterablePagesDocument</code>, which is based off the <code>AbstractFilterPage</code> class. This document is responsible for housing data related to any of the filterable page types that extend <code>AbstractFilterPage</code>, including <code>EnforcementActionPage</code>, <code>BlogPage</code>, <code>EventPage</code>, and <code>NewsroomPage</code>, to name a few. In order to get fields that are specific to a page type, such as the status list for an Enforcement Action, you use the <code>prepare_field</code> function syntax. The use of <code>get_instances_from_related</code> is to enforce the auto-updating of our index when changes occur to a specific page we have indexed, rather than just the relation to <code>AbstractFilterPage</code> that is reflected in the database.</p>
<h3 id="search">Search<a class="headerlink" href="#search" title="Permanent link">Â¶</a></h3>
<p>Search is the final piece of the puzzle, where we actually leverage Elasticsearch to filter and match documents and return them in an ordered <code>QuerySet</code>. Before breaking down the search classes, it's important to discuss the current implementation from an Elasticsearch perspective to understand how we're gathering results.</p>
<p>The expanded search for filterable lists is using a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html">multi-match query</a> across the title, topic name, preview description, and content fields of all <code>FilterablePagesDocument</code>s. We are leveraging a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html#type-phrase">phrase_prefix</a> matching style with a currently configured slop of 2, to allow for some looser matching restrictions. We also provide a boost score for matching to the title and topic name fields, indicated by <code>^10</code> within the code base. This boost score is to enable better ordering by relevance when desired. Search currently supports two different methods of ordering results: relevance and date published. Relevance is calculated by the Elasticsearch engine when returning results, and the date published is calculated based on page publication date. Enforcement Actions define their own ordering logic based on initial filing date. </p>
<h4 id="filterablepagesdocumentsearch">FilterablePagesDocumentSearch<a class="headerlink" href="#filterablepagesdocumentsearch" title="Permanent link">Â¶</a></h4>
<p><code>FilterablePagesDocumentSearch</code> is the core search class that is used across the majority of our searching. It is invoked from <code>FilterableListForm</code>. This search class defines the common structure for our search function, as well as the base logic for filtering against all common fields and logic behind our multi-match and ordering steps. The core function called from outside the class is the <code>search</code> function, which properly chains all of our filter/match/sorting logic and returns the resulting list as a Django <code>QuerySet</code>.</p>
<h4 id="eventfilterablepagesdocumentsearch">EventFilterablePagesDocumentSearch<a class="headerlink" href="#eventfilterablepagesdocumentsearch" title="Permanent link">Â¶</a></h4>
<p><code>EventFilterablePagesDocumentSearch</code> is an extension of <code>FilterablePagesDocumentSearch</code> that defines behavior specific to our future and past Events listings. The class overwrites one method from its parent, the <code>filter_date</code> function, to change the behavior to filter based on fields specific to events, the start and end date of an event.</p>
<h4 id="enforcementactionsfilterablelistform">EnforcementActionsFilterableListForm<a class="headerlink" href="#enforcementactionsfilterablelistform" title="Permanent link">Â¶</a></h4>
<p><code>EnforcementActionsFilterForm</code> is an extension of <code>FilterablePagesDocumentSearch</code> that exposes some additional filter logic through the <code>apply_specific_filters</code> function. We also see that <code>filter_date</code> and <code>order_results</code> have been overwritten to leverage an Enforcement Action-specific field, initial filing date.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../page-search/" class="btn btn-neutral float-right" title="Page Search">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../feature-flags/" class="btn btn-neutral" title="Feature Flags"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/cfpb/consumerfinance.gov/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../feature-flags/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../page-search/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
