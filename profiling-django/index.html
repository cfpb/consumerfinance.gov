<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Profiling Django - consumerfinance.gov</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../css/overrides.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Profiling Django";
    var mkdocs_page_input_path = "profiling-django.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> consumerfinance.gov</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Introduction</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../installation/">Installation</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Running this Project</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../running-virtualenv/">Running in a Virtual Environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../running-docker/">Running in Docker</a>
                </li>
                <li class="">
                    
    <a class="" href="../debugging-monitoring/">Debugging and Monitoring</a>
                </li>
                <li class="">
                    
    <a class="" href="../deployment/">Artifacts and Deployment</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Pages and Components</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../atomic-structure/">Atomic Structure and Design</a>
                </li>
                <li class="">
                    
    <a class="" href="../editing-components/">Creating and Editing Components</a>
                </li>
                <li class="">
                    
    <a class="" href="../debugging-templates/">Debugging Templates</a>
                </li>
                <li class="">
                    
    <a class="" href="../migrations/">Django and Wagtail Migrations</a>
                </li>
                <li class="">
                    
    <a class="" href="../forms-in-wagtail/">Forms in Wagtail Page Context</a>
                </li>
                <li class="">
                    
    <a class="" href="../wagtail-pages/">Wagtail Pages</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Supporting Features</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../caching/">Caching</a>
                </li>
                <li class="">
                    
    <a class="" href="../feature-flags/">Feature Flags</a>
                </li>
                <li class="">
                    
    <a class="" href="../search/">Search</a>
                </li>
                <li class="">
                    
    <a class="" href="../split-testing/">Split Testing</a>
                </li>
                <li class="">
                    
    <a class="" href="../translation/">Translation</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Testing</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../javascript-unit-tests/">JavaScript Unit Testing</a>
                </li>
                <li class="">
                    
    <a class="" href="../python-unit-tests/">Python Unit Testing</a>
                </li>
                <li class="">
                    
    <a class="" href="../functional-testing/">Functional Testing</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Profiling Django</a>
    <ul class="subnav">
            
    
        <ul>
        
            <li><a class="toctree-l4" href="#generating-a-profile-from-a-url">Generating a profile from a URL</a></li>
        
            <li><a class="toctree-l4" href="#understanding-a-generated-profile">Understanding a generated profile</a></li>
        
            <li><a class="toctree-l4" href="#basic-workflow">Basic workflow</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../other-front-end-testing/">Other Front-end Testing</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Contributing</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../branching-merging/">Branching and Merging</a>
                </li>
                <li class="">
                    
    <a class="" href="../contributing-docs/">Contributing to the Docs</a>
                </li>
                <li class="">
                    
    <a class="" href="../related-projects/">Related Projects</a>
                </li>
                <li class="">
                    
    <a class="" href="../development-tips/">Development Tips</a>
                </li>
                <li class="">
                    
    <a class="" href="../github-actions/">How We Use GitHub Actions</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">APIs and Data</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../ask-cfpb/">Ask CFPB</a>
                </li>
                <li class="">
                    
    <a class="" href="../consumer-complaint-database/">Consumer Complaints</a>
                </li>
                <li class="">
                    
    <a class="" href="../housing-counselor-tool/">Find a Housing Counselor Tool</a>
                </li>
                <li class="">
                    
    <a class="" href="../website-feedback/">Website Feedback</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">consumerfinance.gov</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Testing &raquo;</li>
        
      
    
    <li>Profiling Django</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/cfpb/consumerfinance.gov/edit/master/docs/profiling-django.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="profiling-django">Profiling Django<a class="headerlink" href="#profiling-django" title="Permanent link">¶</a></h1>
<p>One tool we have when optimizing our code in Django is profiling. 
Profiling helps us understand where our time is spent, and doing what. 
It also helps us identify duplication of effort, 
as well as targets for caching and optimization.</p>
<p>Because our primary goal is 
to ensure that page loads are as quick as possible for the public, 
this document focuses on profiling the Django request/response cycle: 
view code, Wagtail page rendering, etc.</p>
<p>This document covers the tools we use to 
both generate and understand a profile.</p>
<h2 id="generating-a-profile-from-a-url">Generating a profile from a URL<a class="headerlink" href="#generating-a-profile-from-a-url" title="Permanent link">¶</a></h2>
<p>To enable profile generation, 
we use a middleware that wraps 
<a href="https://docs.python.org/3/library/profile.html">Python's builtin <code>cprofile</code> module</a>, 
<a href="https://github.com/omarish/django-cprofile-middleware">django-cprofile-middleware</a>. 
This middleware is enabled by default for local development 
when <code>DEBUG</code> is <code>True</code>.</p>
<p>For any URL served by Django, 
you can add the <code>?prof</code> querystring 
(or <code>&amp;prof</code> to an existing query string)
in order to see a profile of the request/response cycle for that view. </p>
<p>For example, <code>http://localhost:8000/about-us/newsroom/?prof</code>, 
might return something like:</p>
<pre class="highlight"><code>         1579654 function calls (1575009 primitive calls) in 28.273 seconds

   Ordered by: internal time
   List reduced from 1108 to 500 due to restriction &lt;500&gt;

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
    74952    2.349    0.000   17.292    0.000 utils.py:487(__getattr__)
174882/174880    2.036    0.000    4.559    0.000 {built-in method builtins.isinstance}
    58330    1.985    0.000    5.482    0.000 utils.py:328(__getattr__)
    77732    1.900    0.000    5.027    0.000 utils.py:157(__getattr__)
     2776    1.821    0.001   21.265    0.008 documents.py:89(init_prepare)
     …</code></pre>

<p>You can also sort this output using a <code>sort</code> field. 
For example, to sort by call count instead of the default time sort: <code>http://localhost:8000/about-us/newsroom/?prof&amp;sort=ncalls</code>. 
The can be any supported by 
<a href="https://docs.python.org/3/library/profile.html#pstats.Stats.sort_stats">pstats.Stats.sort_stats</a>.</p>
<p>Most usefully, howevever, 
you can download the <code>.prof</code> file that contains the profile data, 
using a <code>download</code> field.
For example <code>http://localhost:8000/about-us/newsroom/?prof&amp;download</code>. 
This will download <code>view.prof</code>, which you can then open in a tool like
<a href="https://jiffyclub.github.io/snakeviz/"><code>SnakeViz</code></a> 
(see below).</p>
<h2 id="understanding-a-generated-profile">Understanding a generated profile<a class="headerlink" href="#understanding-a-generated-profile" title="Permanent link">¶</a></h2>
<p>There are a number of tools available 
to visualize and understand a <code>.prof</code> profile data file. 
The tool we recommend is 
<a href="https://jiffyclub.github.io/snakeviz/"><code>SnakeViz</code></a>,
a browser-based graphical viewer of cProfile data.</p>
<p>To install SnakeViz locally 
<a href="https://github.com/cfpb/development/blob/main/guides/pipx.md">with pipx</a>:</p>
<pre class="highlight"><code class="language-shell">pipx install snakeviz</code></pre>

<p>After downloading the profile data for a Django view, 
the data can be viewed with SnakeViz with:</p>
<pre class="highlight"><code class="language-shell">snakeviz view.prof</code></pre>

<p>SnakeViz has two visualization styles, 
Icicle and Sunburst. 
Both visualizations represent function calls by 
the time spent inside the function 
as a portion of total time of its calling function. 
The root function will represent 
the total time for the Django request/response cycle.</p>
<p>For example:</p>
<p><img alt="Example SnakeViz Icicle view showing a class-based view call stack" src="../img/profiling-django-snakeviz.png" /></p>
<p>This visualization shows the request/response cycle 
took 27.2s in the root view. 
We can identify the Wagtail <code>serve()</code> view from <code>models.py</code>.</p>
<p>When hovering over a function in the visualization,
you see the function's file, directory, 
and line number in additional context to the left. </p>
<p>If that function is called multiple times, 
other calls will also highlight in the visulization. 
This is a good way to identify duplication that one may wish to refactor.</p>
<h2 id="basic-workflow">Basic workflow<a class="headerlink" href="#basic-workflow" title="Permanent link">¶</a></h2>
<p>Install SnakeViz, if you haven't already:</p>
<pre class="highlight"><code class="language-shell">pipx install snakeviz</code></pre>

<p>Visit the local URL you wish to profile and download the profile data:</p>
<pre class="highlight"><code>http://localhost:8000/about-us/newsroom/?prof&amp;download</code></pre>

<p>Open the profile data in SnakeViz:</p>
<pre class="highlight"><code class="language-shell">snakeviz view.prof</code></pre>

<p>Use the SnakeViz visualization to identify:</p>
<ul>
<li>The call stack of the request/response cycle for a particular Django view</li>
<li>Bottlenecks in the view's request/response cycle</li>
<li>Long calls that can be optimized</li>
<li>Duplicate calls that can be eliminated or cached</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../other-front-end-testing/" class="btn btn-neutral float-right" title="Other Front-end Testing">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../functional-testing/" class="btn btn-neutral" title="Functional Testing"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/cfpb/consumerfinance.gov/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../functional-testing/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../other-front-end-testing/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
