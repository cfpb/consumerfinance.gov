<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Find a Housing Counselor Tool - consumerfinance.gov</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../css/overrides.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Find a Housing Counselor Tool";
        var mkdocs_page_input_path = "housing-counselor-tool.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> consumerfinance.gov
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation/">Setup</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Running this Project</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../running-virtualenv/">Running in a Virtual Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../running-docker/">Running in Docker</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../debugging-monitoring/">Debugging and Monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../deployment/">Artifacts and Deployment</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Pages and Components</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../atomic-structure/">Atomic Structure and Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../editing-components/">Creating and Editing Components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../debugging-templates/">Debugging Templates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../migrations/">Django and Wagtail Migrations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../forms-in-wagtail/">Forms in Wagtail Page Context</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wagtail-pages/">Wagtail Pages</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Supporting Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../caching/">Caching</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../feature-flags/">Feature Flags</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../filterable-lists/">Filterable Lists</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../page-search/">Page Search</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../site-search/">Site Search</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../translation/">Translation</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Testing</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../javascript-unit-tests/">JavaScript Unit Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../python-unit-tests/">Python Unit Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../functional-testing/">Functional Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../profiling-django/">Profiling Django</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../other-front-end-testing/">Other Front-end Testing</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Contributing</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../branching-merging/">Branching and Merging</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../contributing-docs/">Contributing to the Docs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../related-projects/">Related Projects</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development-tips/">Development Tips</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../github-actions/">How We Use GitHub Actions</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">APIs and Data</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../ask-cfpb/">Ask CFPB</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../consumer-complaint-database/">Consumer Complaints</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Find a Housing Counselor Tool</a>
    <ul class="current">
    
        <ul>
        
            <li><a class="toctree-l4" href="#housing-counselor-data-processing">Housing Counselor Data Processing</a></li>
        
        </ul>
    

    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../website-feedback/">Website Feedback</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">consumerfinance.gov</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>APIs and Data &raquo;</li><li>Find a Housing Counselor Tool</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/cfpb/consumerfinance.gov/edit/master/docs/housing-counselor-tool.md"
          class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="find-a-housing-counselor">Find a Housing Counselor<a class="headerlink" href="#find-a-housing-counselor" title="Permanent link">Â¶</a></h1>
<p>The <a href="https://www.consumerfinance.gov/find-a-housing-counselor/">Find a Housing Counselor tool</a> allows users to search for HUD-approved housing counselors.
Users enter a U.S. ZIP code, and the tool returns a list of the ten housing counselors nearest to that ZIP code location.
The page also displays a map of the results using Mapbox.</p>
<p>When the user enters a ZIP code in the page's search box, the <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/housing_counselor/views.py#L84">Django view</a> fetches a JSON file of the results from our Amazon S3 bucket.
The results are inserted into the <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/housing_counselor/jinja2/housing_counselor/index.html">page template</a> and the <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/unprocessed/apps/find-a-housing-counselor/js/common.js">Mapbox map</a>.
The page also contains a link to a PDF version of the results, which is also stored in S3.
The files are publicly accessible, so the tool can run on localhost or in a container without any change in behavior.</p>
<p>This page documents the process we use to generate the JSON and PDF files the Find a Housing Counselor tool relies on.</p>
<h2 id="housing-counselor-data-processing">Housing Counselor Data Processing<a class="headerlink" href="#housing-counselor-data-processing" title="Permanent link">Â¶</a></h2>
<p>The tool gets its data from the U.S. Department of Housing and Urban Development (HUD).
HUD provides an <a href="https://data.hud.gov/housing_counseling.html">API</a> to their list of approved counseling agencies.
A daily job, <code>cf.gov-housing-counselor-data</code> on our external Jenkins server,
queries HUD data and produces the JSON and PDF files we use for the Find a Housing Counselor tool.
It performs the following steps, each of which is optional
and configured using parameters before starting the job.</p>
<ol>
<li><a href="#geocode-zip-codes">Geocode ZIP codes</a> (<code>GEOCODE_ZIPCODES</code>)</li>
<li><a href="#generate-json-files">Generate JSON files</a> (<code>MAKE_JSON</code>)</li>
<li><a href="#generate-html-files">Generate HTML files</a> (<code>MAKE_HTML</code>)</li>
<li><a href="#generate-pdfs">Generate PDFs</a> (<code>MAKE_PDF</code>)</li>
<li><a href="#upload-to-s3">Upload to S3</a> (<code>UPLOAD_TO_S3</code>)</li>
</ol>
<h3 id="geocode-zip-codes">Geocode ZIP codes<a class="headerlink" href="#geocode-zip-codes" title="Permanent link">Â¶</a></h3>
<p>The <code>GEOCODE_ZIPCODES</code> step generates a file of all ZIP codes in the United States and their location latitude and longitude and saves it in the Jenkins workspace.
By default, this step is not enabled.
Since ZIP code geographical information rarely changes, we run this step rarely by manually enabling the option in the Jenkins job.</p>
<p>If enabled, this step calls the <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/housing_counselor/management/commands/hud_geocode_zipcodes.py"><code>hud_geocode_zipcodes</code></a> management command.
The management command in turn calls the <code>BulkZipCodeGeocoder</code> in <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/housing_counselor/geocoder.py"><code>geocoder.py</code></a>.
<code>BulkZipCodeGeocoder</code> uses the <a href="https://www.mapbox.com/">Mapbox</a> geocoding API to determine which 5-digit number sequences are ZIP codes and fetch their latitude and longitude values.
The management command inserts this data into a CSV and saves it to <code>./zipcodes.csv</code> on the Jenkins job workspace.</p>
<p>The generated file looks like this:</p>
<pre class="highlight"><code class="language-csv">12305,42.81,-73.94
12306,42.77,-73.96
12307,42.81,-73.93
12308,42.82,-73.93
12309,42.81,-73.91
12325,42.88779,-73.99597
12345,42.80856,-74.02737</code></pre>
<h3 id="generate-json-files">Generate JSON files<a class="headerlink" href="#generate-json-files" title="Permanent link">Â¶</a></h3>
<p>When enabled, the <code>MAKE_JSON</code> step generates a JSON file of housing counselor data for each ZIP code in the U.S.
Each file contains the ten results geographically nearest to the ZIP code's latitude and longitude.
This step is enabled by default.</p>
<p>This step calls the <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/housing_counselor/management/commands/hud_generate_json.py"><code>hud_generate_json</code></a> management command,
which performs the following steps:</p>
<ol>
<li>fetch agency listings from HUD</li>
<li>save a copy of the full results, for our records</li>
<li>clean the results</li>
<li>fill in any missing latitude and longitude values</li>
<li>create files of the 10 nearest results for each U.S. ZIP code</li>
</ol>
<h4 id="fetch-agency-listings">Fetch agency listings<a class="headerlink" href="#fetch-agency-listings" title="Permanent link">Â¶</a></h4>
<p>(<em>in <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/housing_counselor/fetcher.py"><code>fetcher.py</code></a></em>)</p>
<p>Request every housing counselor in HUD's database
with a request to <code>https://data.hud.gov/Housing_Counselor/searchByLocation?Lat=38.8951&amp;Long=-77.0367&amp;Distance=5000</code>.</p>
<p>It returns thousands of results like this:</p>
<pre class="highlight"><code class="language-json">{
    "services": "DFC,FBC,PPC,RHC",
    "languages": "ENG,SPA",
    "agc_STATUS": "A",
    "agc_SRC_CD": "HUD",
    "counslg_METHOD": "Face to Face Counseling,Group Counseling,Phone Counseling",
    "agcid": "80790",
    "adr1": "1234 N. Example St.",
    "adr2": " ",
    "city": "SPRINGFIELD",
    "email": "counselor@example.org",
    "fax": "999-888-7777",
    "nme": "EXAMPLE COMMUNITY HOUSING SERVICES",
    "phone1": "111-222-3333",
    "statecd": "MI",
    "weburl": "www.example.org",
    "zipcd": "48219-8888",
    "agc_ADDR_LATITUDE": "42.442658",
    "agc_ADDR_LONGITUDE": "-83.28329",
    "parentid": "81228",
    "county_NME": "",
    "phone2": " ",
    "mailingadr1": "1234 N. Example St.",
    "mailingadr2": " ",
    "mailingcity": "SPRINGFIELD",
    "mailingzipcd": "48219-8888",
    "mailingstatecd": "MI",
    "state_NME": "Michigan",
    "state_FIPS_CODE": null,
    "faithbased": "N",
    "colonias_IND": "Y",
    "migrantwkrs_IND": "N"
},</code></pre>
<p>Next, we replace the <code>languages</code> value with the full language names.
We replace the <code>services</code> value with fully spelled out service descriptions.
Both of these mappings come from the HUD API.</p>
<h4 id="save-the-results">Save the results<a class="headerlink" href="#save-the-results" title="Permanent link">Â¶</a></h4>
<p>(<em>in <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/housing_counselor/results_archiver.py"><code>results_archiver.py</code></a></em>)</p>
<p>Save a copy of the full set of results as a zip file in the home directory.
The Jenkins job then transfers the zip file to S3 as part of the <code>MAKE JSON</code> step.
The file is saved in S3 at <code>/archive/{date}.zip</code>.
This copy can be used as the canonical set of HUD data that day in case of an enforcement action.</p>
<h4 id="clean-the-results">Clean the results<a class="headerlink" href="#clean-the-results" title="Permanent link">Â¶</a></h4>
<p>(<em>in <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/housing_counselor/cleaner.py"><code>cleaner.py</code></a></em>)</p>
<p>Clean the data: Convert latitude and longitude values to float values.
Convert the the city and organization name to title case.
Ensure email appears to be an email (otherwise leave it blank).
If a URL value is present, ensure it begins with <code>http://</code>.</p>
<h4 id="backfill-missing-latitude-and-longitude-values">Backfill missing latitude and longitude values<a class="headerlink" href="#backfill-missing-latitude-and-longitude-values" title="Permanent link">Â¶</a></h4>
<p>(<em>in <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/housing_counselor/geocoder.py"><code>geocoder.py</code></a></em>)</p>
<p>If any counselor records are missing their latitude or longitude data,
we fill in those values with the lat/long location of the agency's ZIP code.
This uses the data file created in the Geocode ZIP Codes stage of the Jenkins job (<a href="#geocode-zip-codes">above</a>).</p>
<h4 id="create-collections-of-results-by-zip-code">Create collections of results by ZIP code<a class="headerlink" href="#create-collections-of-results-by-zip-code" title="Permanent link">Â¶</a></h4>
<p>(<em>in <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/housing_counselor/generator.py"><code>generator.py</code></a></em>)</p>
<p>Create an in-memory SQLite database and define a <code>distance_in_miles</code> function in it.
Fill the database with a three-column table:
For each counselor in the list, include its latitude and longitude (both in radians) and
all of its information from the HUD API as a JSON text string.</p>
<p>For each ZIP code in the U.S., query the database to find the 10 closest housing counselors to the lat/long of that ZIP.
Put the information in a JSON structure like this (but with ten results instead of one):</p>
<pre class="highlight"><code class="language-json">{
    "zip": {
        "lat": 42.80856,
        "lng": -74.02737,
        "zipcode": "12345"
    },
    "counseling_agencies": [{
        "adr1": "1234 N. Example St.",
        "state_FIPS_CODE": null,
        "adr2": " ",
        "zipcd": "48219-8888",
        "mailingcity": "Springfield",
        "weburl": "http://www.example.org",
        "agc_STATUS": "A",
        "city": "Springfield",
        "languages": ["English", "Spanish"],
        "faithbased": "N",
        "mailingstatecd": "MI",
        "email": "counselor@example.org",
        "fax": "999-888-7777",
        "phone1": "111-222-3333",
        "distance": 5.430720023569205,
        "phone2": " ",
        "agc_ADDR_LATITUDE": 42.442658,
        "agcid": "80790",
        "agc_SRC_CD": "HUD",
        "nme": "Example Community Housing Services",
        "migrantwkrs_IND": "N",
        "parentid": "82772",
        "services": ["Mortgage Delinquency and Default Resolution Counse", "Home Improvement and Rehabilitation Counseling", "Pre-purchase Counseling", "Pre-purchase Homebuyer Education Workshops", "Rental Housing Counseling"],
        "counslg_METHOD": "Face to Face Counseling,Group Counseling,Phone Counseling",
        "county_NME": "",
        "mailingadr1": "1234 N. Example St.",
        "statecd": "MI",
        "mailingadr2": " ",
        "mailingzipcd": "48219-8888",
        "state_NME": "Michigan",
        "agc_ADDR_LONGITUDE": -83.28329,
        "colonias_IND": "Y"
    }]
}</code></pre>
<p>Save the resulting JSON files on the Jenkins job workspace, in a <code>jsons</code> directory, e.g. <code>jsons/12345.json</code>.</p>
<h3 id="generate-html-files">Generate HTML files<a class="headerlink" href="#generate-html-files" title="Permanent link">Â¶</a></h3>
<p>When enabled, the <code>MAKE_HTML</code> step generates an HTML page of housing counselor results, including styles,
for each file created in the previous step.
It saves them in an <code>htmls</code> directory on the Jenkins job workspace.
This step is enabled by default.</p>
<p>This step calls the <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/housing_counselor/management/commands/hud_generate_html.py"><code>hud_generate_html</code></a> management command,
which calls HTML generation code in <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/housing_counselor/generator.py"><code>generator.py</code></a>.
Django renders the <a href="https://github.com/cfpb/consumerfinance.gov/blob/main/cfgov/housing_counselor/templates/housing_counselor/pdf_selfcontained.html"><code>housing_counselor/pdf_selfcontained.html</code></a> template with the housing counselor data from each JSON file.
We save the resulting HTML files on the Jenkins job workspace, in a <code>htmls</code> directory, e.g. <code>htmls/12345.html</code>.</p>
<h3 id="generate-pdfs">Generate PDFs<a class="headerlink" href="#generate-pdfs" title="Permanent link">Â¶</a></h3>
<p>When enabled, the <code>MAKE_PDF</code> step generates a PDF of each file created in the previous step.
It saves them in a <code>pdfs</code> directory on the Jenkins job workspace.
This step is enabled by default.</p>
<p>This step uses a HTML to PDF conversion command line tool.
We run the conversion on each file in the <code>htmls</code> directory, generating a PDF version of each, e.g. <code>pdfs/12345.pdf</code>.</p>
<h3 id="upload-to-s3">Upload to S3<a class="headerlink" href="#upload-to-s3" title="Permanent link">Â¶</a></h3>
<p>When enabled, the <code>UPLOAD_TO_S3</code> step uploads the contents of the <code>jsons</code> and <code>pdfs</code> directories to an Amazon S3 bucket where it can be accessed by consumerfinance.gov.
This step is enabled by default.</p>
<p>The files are publicly accessible, e.g.:</p>
<ul>
<li><a href="https://files.consumerfinance.gov/a/assets/hud/jsons/12345.json">https://files.consumerfinance.gov/a/assets/hud/jsons/12345.json</a></li>
<li><a href="https://files.consumerfinance.gov/a/assets/hud/pdfs/12345.pdf">https://files.consumerfinance.gov/a/assets/hud/pdfs/12345.pdf</a></li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../consumer-complaint-database/" class="btn btn-neutral float-left" title="Consumer Complaints"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../website-feedback/" class="btn btn-neutral float-right" title="Website Feedback">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/cfpb/consumerfinance.gov" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../consumer-complaint-database/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../website-feedback/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
